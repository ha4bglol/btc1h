<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVRA - Блекджек</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --neon-pink: #f9009a;
            --neon-cyan: #00f9f9;
            --neon-purple: #9d00f9;
            --neon-green: #39ff14;
            --dark-bg: #10081c;
        }
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 1% 1%, rgba(157, 0, 249, 0.3), transparent 30%),
                radial-gradient(circle at 99% 99%, rgba(0, 249, 249, 0.2), transparent 30%);
            color: #e0e0e0;
            overflow-x: hidden;
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .btn-action {
            padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase; transition: all 0.3s ease;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-purple)); color: white; box-shadow: 0 0 15px var(--neon-pink); border: none;
        }
        .btn-action:hover:not(:disabled) {
            box-shadow: 0 0 25px var(--neon-pink), 0 0 40px var(--neon-purple); transform: translateY(-2px) scale(1.05);
        }
        .btn-action:disabled {
            background: #4a4a6a; color: #8f8f8f; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none;
        }
        .btn-secondary {
            padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase; transition: all 0.3s ease;
            background: transparent; color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); border: 2px solid var(--neon-cyan);
        }
        .btn-secondary:hover:not(:disabled) {
            background: var(--neon-cyan); color: var(--dark-bg); transform: translateY(-2px) scale(1.05);
        }
        .btn-secondary:disabled {
            background: transparent; border-color: #4a4a6a; color: #8f8f8f; cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none;
        }
        .form-input { 
            background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 12px; padding: 0.8rem 1rem; width: 100%; transition: all 0.3s ease;
        }
        .form-input:focus { 
            outline: none; border-color: var(--neon-cyan); background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 15px rgba(0, 249, 249, 0.2); 
        }
        .video-container {
            border: 2px solid; border-image-slice: 1; border-image-source: linear-gradient(to bottom, var(--neon-cyan), var(--neon-pink));
            box-shadow: 0 0 20px rgba(0, 249, 249, 0.3), 0 0 20px rgba(249, 0, 154, 0.3);
            overflow: hidden; border-radius: 1rem; position: relative;
        }
        .video-container .video-player {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease-in-out;
        }
        .game-board {
            background-color: rgba(6, 78, 59, 0.2);
            background-image: radial-gradient(ellipse at center, rgba(16, 138, 68, 0.3) 0%, transparent 70%);
            border: 1px solid var(--neon-green);
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.2);
            position: relative; overflow: hidden; z-index: 1;
        }
        .game-board::before { 
            content: 'NIVRA'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Orbitron', sans-serif;
            font-size: clamp(6rem, 20vw, 10rem); font-weight: 900; color: rgba(57, 255, 20, 0.05); pointer-events: none; z-index: -1; 
        }
        .card {
            width: 110px; height: 160px;
            background: rgba(16, 8, 28, 0.7); backdrop-filter: blur(5px);
            border: 1px solid var(--neon-purple);
            box-shadow: 0 0 10px var(--neon-purple), inset 0 0 5px rgba(157, 0, 249, 0.5);
            color: #e0e0e0; border-radius: 10px; padding: 10px; 
            display: flex; flex-direction: column; justify-content: space-between; font-weight: 600; position: relative;
            transform: scale(0); animation: deal-card 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes deal-card { from { opacity: 0; transform: translateY(60px) rotateX(-30deg) rotateZ(15deg) scale(0.7); } to { opacity: 1; transform: translateY(0) rotateX(0) rotateZ(0) scale(1); } }
        .card.red .card-suit, .card.red .card-rank { color: var(--neon-pink); text-shadow: 0 0 8px var(--neon-pink); }
        .card.black .card-suit, .card.black .card-rank { color: var(--neon-cyan); text-shadow: 0 0 8px var(--neon-cyan); }
        .card-rank { font-size: 1.75rem; font-weight: 700; font-family: 'Orbitron', sans-serif; }
        .card-suit { font-size: 1.5rem; }
        .card-suit-center { font-size: 3.5rem; }
        .card .top-left { position: absolute; top: 8px; left: 10px; text-align: center; line-height: 1; }
        .card .bottom-right { position: absolute; bottom: 8px; right: 10px; transform: rotate(180deg); text-align: center; line-height: 1; }
        .card.facedown {
            background: linear-gradient(145deg, var(--dark-bg), #2a144a);
            border-image-slice: 1; border-image-source: linear-gradient(to bottom right, var(--neon-cyan), var(--neon-pink));
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .card.facedown::before {
            content: 'NIVRA'; font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.8rem;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            transform: rotate(-30deg); text-shadow: 0 0 15px var(--neon-purple);
        }
        .card.facedown > div { display: none; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-40 shadow-lg" style="background: rgba(16, 8, 28, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold gradient-text flex-shrink-0" style="font-family: 'Orbitron', sans-serif;">NIVRA</a>
            <a href="index.html" class="text-gray-300 hover:text-cyan-400 transition text-lg font-semibold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span class="hidden sm:inline">Обратно към лобито</span>
            </a>
        </nav>
    </header>

    <main class="min-h-[calc(100vh-160px)] flex items-center justify-center py-12 px-4">
        
        <section id="login-required-container" class="w-full max-w-2xl hidden">
            <div class="p-8 text-center flex flex-col items-center gap-6" style="background: linear-gradient(145deg, #1c102f, #10081c); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                <i class="fas fa-lock text-7xl text-cyan-400"></i>
                <h2 class="text-4xl font-bold gradient-text" style="font-family: 'Orbitron', sans-serif;">Достъпът е ограничен</h2>
                <p class="text-gray-300 text-lg max-w-md">Трябва да сте влезли в профила си и да имате потвърден имейл, за да играете Блекджек.</p>
                <a href="index.html" class="mt-4 px-8 py-3 rounded-full text-xl btn-action inline-block">Към лобито / Вход</a>
            </div>
        </section>

        <div id="game-and-videos-layout" class="container mx-auto hidden">
             <div class="flex flex-row items-stretch justify-center gap-4 lg:gap-8">
                
                <div class="hidden lg:block w-1/5 video-container">
                    <video id="left-video-1" class="video-player" autoplay muted playsinline></video>
                    <video id="left-video-2" class="video-player" muted playsinline></video>
                </div>

                <section id="blackjack-game-container" class="w-full max-w-6xl">
                    <div class="flex flex-col md:flex-row gap-8 p-6 md:p-8 rounded-2xl" style="background: rgba(16, 8, 28, 0.7); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);">
                        
                        <div class="w-full md:w-1/3 lg:w-1/4 p-6 rounded-xl flex flex-col" style="background: rgba(16, 8, 28, 0.9); border: 1px solid rgba(255,255,255,0.1);">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-3xl font-bold" style="font-family: 'Orbitron', sans-serif;">Блекджек</h3>
                                <div class="text-lg font-semibold flex items-center gap-2 text-cyan-400">
                                    <i class="fas fa-coins"></i>
                                    <span id="balance-display" style="font-family: 'Orbitron', sans-serif;">0.00</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="bet-amount" class="block text-sm font-medium text-gray-400 mb-2">Залог</label>
                                <input type="number" id="bet-amount" value="10" class="form-input">
                            </div>
                            <div class="rounded-lg p-4 mb-6 text-center h-24 flex items-center justify-center" style="background: rgba(0,0,0,0.3);">
                                <p id="game-status-display" class="text-xl font-bold text-cyan-400" style="font-family: 'Orbitron', sans-serif;">Направете залог</p>
                            </div>
                            <div class="mt-auto space-y-3">
                                <button id="deal-btn" class="w-full py-4 text-xl btn-action">Раздай</button>
                                <div id="player-actions" class="grid grid-cols-2 gap-3 hidden">
                                     <button id="hit-btn" class="w-full py-3 btn-secondary">Удари</button>
                                     <button id="stand-btn" class="w-full py-3 btn-secondary">Пасувай</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="w-full md:w-2/3 lg:w-3/4 flex items-center justify-center">
                            <div class="game-board w-full rounded-xl p-4 md:p-6 flex flex-col justify-between gap-8 min-h-[450px]">
                                <div>
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-xl font-semibold">Ръка на Дилъра</h4>
                                        <p class="text-2xl font-bold bg-black bg-opacity-40 px-3 py-1 rounded-md" id="dealer-score" style="font-family: 'Orbitron', sans-serif;"></p>
                                    </div>
                                    <div id="dealer-cards" class="flex justify-center items-center gap-4 min-h-[180px]"></div>
                                </div>
                                <div>
                                    <div id="player-cards" class="flex justify-center items-center gap-4 min-h-[180px] mb-4"></div>
                                     <div class="flex justify-between items-center">
                                        <h4 class="text-xl font-semibold">Твоята Ръка</h4>
                                        <p class="text-2xl font-bold bg-black bg-opacity-40 px-3 py-1 rounded-md" id="player-score" style="font-family: 'Orbitron', sans-serif;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="hidden lg:block w-1/5 video-container">
                    <video id="right-video-1" class="video-player" autoplay muted playsinline></video>
                    <video id="right-video-2" class="video-player" muted playsinline></video>
                </div>
             </div>
        </div>
    </main>

    <footer class="bg-black/30 text-gray-400 py-6">
        <div class="container mx-auto px-6 text-center">
            <p class="text-xs text-gray-500">Играта е предназначена само за забавление за лица над 18 години. Използват се виртуални кредити без реална стойност.</p>
            <p class="text-sm mt-2">&copy; 2024 NIVRA. Всички права запазени.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.appspot.com",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e36e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const gameLayout = document.getElementById('game-and-videos-layout');
        const loginRequiredContainer = document.getElementById('login-required-container');
        const blackjackGameContainer = document.getElementById('blackjack-game-container');
        let unsubscribeUserListener;

        function initializeVideoPlayers() {
            const videoFiles = [ "blackgirl1_v1.webm", "blackgirl2_v1.webm", "blackgirl3_v1.webm", "blackgirl4_v1.webm", "blackgirl5_v1.webm", "blackgirl6_v1.webm" ];
            const left1 = document.getElementById('left-video-1'), left2 = document.getElementById('left-video-2');
            const right1 = document.getElementById('right-video-1'), right2 = document.getElementById('right-video-2');

            let activePlayers = [left1, right1], nextPlayers = [left2, right2];
            [...activePlayers, ...nextPlayers].forEach(v => v.style.opacity = 0);
            const getRandomVideoSrc = () => videoFiles[Math.floor(Math.random() * videoFiles.length)];

            const initialSrc = getRandomVideoSrc();
            activePlayers.forEach(v => { v.src = initialSrc; });
            let nextSrc = getRandomVideoSrc();
            nextPlayers.forEach(v => { v.src = nextSrc; });
            
            activePlayers[0].addEventListener('canplay', () => { activePlayers.forEach(v => v.style.opacity = 1); }, { once: true });

            function switchVideos() {
                nextPlayers.forEach(p => p.play().catch(e => console.error("Video play failed", e)));
                activePlayers.forEach(p => p.style.opacity = 0);
                nextPlayers.forEach(p => p.style.opacity = 1);
                const temp = activePlayers; activePlayers = nextPlayers; nextPlayers = temp;
                nextSrc = getRandomVideoSrc();
                nextPlayers.forEach(p => { p.currentTime = 0; p.src = nextSrc; });
            }
            
            function checkTimeLoop() {
                const masterVideo = activePlayers[0];
                if (masterVideo.duration && masterVideo.currentTime > masterVideo.duration - 0.4) { switchVideos(); }
                requestAnimationFrame(checkTimeLoop);
            }
            checkTimeLoop();
        }
        
        initializeVideoPlayers();

        onAuthStateChanged(auth, (user) => {
            if (unsubscribeUserListener) unsubscribeUserListener(); 
            if (user && user.emailVerified) {
                gameLayout.classList.remove('hidden');
                loginRequiredContainer.classList.add('hidden');
                const userDocRef = doc(db, 'users', user.uid);
                initializeBlackjackGame(userDocRef);
            } else {
                gameLayout.classList.add('hidden');
                loginRequiredContainer.classList.remove('hidden');
            }
        });
        
        function initializeBlackjackGame(userDocRef) {
            // DOM Elements
            const balanceDisplay = document.getElementById('balance-display');
            const betAmountInput = document.getElementById('bet-amount');
            const gameStatusDisplay = document.getElementById('game-status-display');
            const dealBtn = document.getElementById('deal-btn');
            const playerActions = document.getElementById('player-actions');
            const hitBtn = document.getElementById('hit-btn');
            const standBtn = document.getElementById('stand-btn');
            const dealerScoreDisplay = document.getElementById('dealer-score');
            const playerScoreDisplay = document.getElementById('player-score');
            const dealerCardsContainer = document.getElementById('dealer-cards');
            const playerCardsContainer = document.getElementById('player-cards');
            
            // Game State
            let currentBalance = 0;
            let deck = [];
            let playerHand = [], dealerHand = [];
            let playerScore = 0, dealerScore = 0;

            unsubscribeUserListener = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBalance = docSnap.data().chips;
                    balanceDisplay.textContent = currentBalance.toFixed(2);
                } else { console.error("User document not found!"); }
            });

            async function updateBalanceInFirestore(newBalance) {
                if (!userDocRef) return;
                try { await updateDoc(userDocRef, { chips: newBalance }); }
                catch (error) { console.error("Error updating balance:", error); }
            }
            
            function createDeck() {
                const suits = ['♥', '♦', '♣', '♠'];
                const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                let newDeck = [];
                for (const suit of suits) {
                    for (const rank of ranks) {
                        let value = ['J', 'Q', 'K'].includes(rank) ? 10 : rank === 'A' ? 11 : parseInt(rank);
                        newDeck.push({ suit, rank, value });
                    }
                }
                for (let i = newDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
                }
                return newDeck;
            }

            function renderCard(card, container, delay, isFaceDown = false) {
                const cardEl = document.createElement('div');
                cardEl.classList.add('card');
                cardEl.style.animationDelay = `${delay}ms`;

                if (isFaceDown) {
                    cardEl.classList.add('facedown');
                } else {
                    cardEl.innerHTML = `
                        <div class="top-left"><div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div></div>
                        <div class="card-suit-center flex-grow flex items-center justify-center card-suit">${card.suit}</div>
                        <div class="bottom-right"><div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div></div>
                    `;
                    if (['♥', '♦'].includes(card.suit)) cardEl.classList.add('red');
                    else cardEl.classList.add('black');
                }
                container.appendChild(cardEl);
            }
            
            function calculateScore(hand) {
                let score = hand.reduce((sum, card) => sum + card.value, 0);
                let aceCount = hand.filter(card => card.rank === 'A').length;
                while (score > 21 && aceCount > 0) { score -= 10; aceCount--; }
                return score;
            }

            function updateScores() {
                playerScore = calculateScore(playerHand);
                dealerScore = calculateScore(dealerHand.slice(0, 1)); 
                playerScoreDisplay.textContent = playerScore;
                dealerScoreDisplay.textContent = dealerHand.length > 1 ? `${dealerScore} + ?` : '';
            }
            
            function setStatus(message, colorClass = 'text-cyan-400') {
                gameStatusDisplay.textContent = message;
                gameStatusDisplay.className = `text-xl font-bold transition-colors duration-300 ${colorClass}`;
                gameStatusDisplay.style.fontFamily = "'Orbitron', sans-serif";
            }

            function setUiState(state) {
                betAmountInput.disabled = (state !== 'pre-game');
                dealBtn.classList.toggle('hidden', state !== 'pre-game');
                playerActions.classList.toggle('hidden', state !== 'player-turn');
            }

            function dealCard(hand, container, isFaceDown = false) {
                const card = deck.pop();
                hand.push(card);
                const delay = (hand.length - 1) * 150 + (container === dealerCardsContainer ? 50 : 0);
                renderCard(card, container, delay, isFaceDown);
            }

            async function startGame() {
                const bet = parseFloat(betAmountInput.value);
                if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                    setStatus('Невалиден залог!', 'text-red-500'); return;
                }

                await updateBalanceInFirestore(currentBalance - bet);
                playerCardsContainer.innerHTML = ''; dealerCardsContainer.innerHTML = '';
                playerHand = []; dealerHand = []; deck = createDeck();
                
                setStatus('Раздаване...', 'text-white');
                setUiState('dealing'); 

                dealCard(playerHand, playerCardsContainer);
                dealCard(dealerHand, dealerCardsContainer);
                dealCard(playerHand, playerCardsContainer);
                dealCard(dealerHand, dealerCardsContainer, true); 
                
                updateScores();
                
                setTimeout(() => {
                    if (calculateScore(playerHand) === 21) {
                        playerStand(true); 
                    } else {
                        setStatus('Твой ред...', 'text-white');
                        setUiState('player-turn');
                    }
                }, 1000);
            }

            function playerHit() {
                dealCard(playerHand, playerCardsContainer);
                updateScores();
                if (playerScore > 21) {
                    setStatus('Бюст!', 'text-red-500');
                    endGame(0);
                }
            }

            function playerStand(isBlackjack = false) {
                setUiState('dealer-turn');
                setStatus('Ред на дилъра...', 'text-white');
                setTimeout(() => dealerTurn(isBlackjack), 800);
            }

            function dealerTurn(playerHasBlackjack) {
                dealerCardsContainer.children[1].remove();
                renderCard(dealerHand[1], dealerCardsContainer, 0);
                
                const drawLoop = setInterval(() => {
                    let currentDealerScore = calculateScore(dealerHand);
                    dealerScoreDisplay.textContent = currentDealerScore;
                    if (currentDealerScore >= 17) {
                        clearInterval(drawLoop);
                        determineWinner(playerHasBlackjack);
                    } else {
                        dealCard(dealerHand, dealerCardsContainer);
                    }
                }, 800);
            }

            function determineWinner(playerHasBlackjack) {
                const finalPlayerScore = calculateScore(playerHand);
                const finalDealerScore = calculateScore(dealerHand);

                if (playerHasBlackjack && finalDealerScore !== 21) {
                    setStatus('Блекджек! 3:2', 'text-green-400'); endGame(2.5);
                } else if (finalPlayerScore > 21) {
                    setStatus('Дилърът печели!', 'text-red-500'); endGame(0);
                } else if (finalDealerScore > 21 || finalPlayerScore > finalDealerScore) {
                    setStatus('Ти печелиш!', 'text-green-400'); endGame(2);
                } else if (finalDealerScore > finalPlayerScore) {
                    setStatus('Дилърът печели!', 'text-red-500'); endGame(0);
                } else {
                    setStatus('Равенство', 'text-gray-400'); endGame(1);
                }
            }
            
            async function endGame(payoutMultiplier) {
                const bet = parseFloat(betAmountInput.value);
                const winnings = bet * payoutMultiplier;
                if (winnings > 0) {
                   await updateBalanceInFirestore(currentBalance + winnings);
                }
                setUiState('pre-game');
            }

            dealBtn.addEventListener('click', startGame);
            hitBtn.addEventListener('click', playerHit);
            standBtn.addEventListener('click', () => playerStand(false));
        }
    </script>
</body>
</html>
</html>

