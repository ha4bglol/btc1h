<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVRA World - Вашето място за забавления</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-primary: #100a1c;
            --bg-secondary: rgba(16, 10, 28, 0.6);
            --glow-color-1: #00ffc3;
            --nivra-gold: #f7b733;
            --nivra-orange: #fc4a1a;
            --nivra-gradient: linear-gradient(90deg, var(--nivra-gold), var(--nivra-orange));
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent-text-color: #100a1c;
            --border-color: rgba(247, 183, 51, 0.2);
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Poppins', sans-serif;
        }
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow-x: hidden; font-family: var(--font-body); color: var(--text-primary);
        }
        body {
            background: linear-gradient(135deg, #f900ff, #00ffc3, #2e005e, #100a1c);
            background-size: 400% 400%;
            animation: color-shift 20s ease-in-out infinite;
        }
        @keyframes color-shift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* --- General UI Elements --- */
        .btn {
            font-family: var(--font-display); font-weight: 700; padding: 0.8rem 1.5rem; border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none;
        }
        .btn-primary {
            background: var(--nivra-gradient); color: var(--accent-text-color);
            box-shadow: 0 0 15px rgba(247, 183, 51, 0.3), 0 0 30px rgba(252, 74, 26, 0.2);
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 0 25px rgba(247, 183, 51, 0.5), 0 0 50px rgba(252, 74, 26, 0.3); }
        .btn-primary:disabled, .btn-secondary:disabled { background: #4a4a6a; color: #8f8f8f; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; border-color: #4a4a6a;}
        .btn-secondary {
            background: transparent; color: var(--nivra-gold); border: 2px solid var(--nivra-gold);
        }
        .btn-secondary:hover:not(:disabled) { background: var(--nivra-gold); color: var(--bg-primary); }
        .gradient-text { background: var(--nivra-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Main Layout --- */
        #app-container { display: none; flex-direction: column; width: 100%; min-height: 100%; position: relative; }
        #app-header {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;
            background: rgba(16, 10, 28, 0.7); backdrop-filter: blur(10px); z-index: 10;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .logo { font-family: var(--font-display); font-size: 2rem; font-weight: 900; }
        #user-info { display: flex; align-items: center; gap: 1.5rem; }
        #user-balance { font-size: 1.2rem; font-weight: 600; color: var(--nivra-gold); display: flex; align-items: center; gap: 0.5rem; }
        #user-balance .fas { animation: coin-pulse 2s infinite; }
        @keyframes coin-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        #main-content { flex-grow: 1; display: flex; overflow: hidden; }
        #tab-nav {
            display: flex; flex-direction: column; gap: 0.5rem; padding: 2rem 1rem;
            background: rgba(16, 10, 28, 0.7); border-right: 1px solid var(--border-color); flex-shrink: 0;
        }
        .tab-btn {
            font-family: var(--font-display); font-size: 1.1rem; padding: 1rem; border-radius: 10px;
            color: var(--text-secondary); cursor: pointer; text-align: left; white-space: nowrap;
            border-left: 4px solid transparent; transition: all 0.3s ease; background: none; border-right: none; border-top: none; border-bottom: none;
        }
        .tab-btn:hover { background: rgba(247, 183, 51, 0.1); color: var(--nivra-gold); }
        .tab-btn.active {
            background: rgba(247, 183, 51, 0.15); color: #fff;
            border-left-color: var(--nivra-gold); text-shadow: 0 0 10px var(--nivra-gold);
        }
        #content-area { flex-grow: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        .tab-panel { display: none; animation: fadeIn 0.5s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Screens & Modals --- */
        .full-screen-overlay {
            position: fixed; inset: 0; background-color: var(--bg-primary); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2rem;
            transition: opacity 0.5s ease-out; text-align: center; padding: 1rem;
        }
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 9000; display: none; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: radial-gradient(circle at top, #2a2a40, #1a1a2e);
            border: 2px solid var(--nivra-gold); border-radius: 1rem; padding: 2rem;
            max-width: 90vw; width: 500px; box-shadow: 0 0 50px rgba(247, 183, 51, 0.3);
            text-align: center; position: relative;
        }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; background: none; border: none; padding: 0.5rem; /* MOBILE OPTIMIZATION: Bigger tap area */ }
        
        /* --- Toast Notification --- */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; display: flex; flex-direction: column-reverse; gap: 10px; }
        .toast {
            background: var(--nivra-gradient); color: var(--accent-text-color); padding: 1rem 1.5rem; border-radius: 10px;
            font-family: var(--font-display); font-weight: 700; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: slideUp 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
        }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: translateY(100%); } }

        /* --- Marketplace & Collection Styles --- */
        #market-container { display: flex; gap: 2rem; }
        #market-grid, #collection-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
        .market-item {
            background: var(--bg-secondary); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;
            position: relative; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
            display: flex; flex-direction: column;
        }
        .market-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 0 20px var(--glow-color-1); }
        .market-item.selected { border-color: var(--nivra-gold); box-shadow: 0 0 15px var(--nivra-gold); }
        .item-thumbnail { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .item-info { padding: 1rem; text-align: left; flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-family: var(--font-display); font-size: 1.2rem; margin-bottom: 0.5rem; }
        .item-description { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; flex-grow: 1; }
        .item-price { font-size: 1.3rem; font-weight: bold; color: var(--nivra-gold); text-align: right; }
        .item-owned-overlay {
            position: absolute; inset: 0; background: rgba(0, 255, 195, 0.6); backdrop-filter: blur(2px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--bg-primary);
            font-family: var(--font-display); font-size: 1.5rem; font-weight: 900; text-align: center;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .market-item.owned .item-owned-overlay { opacity: 1; }
        .market-item.owned { cursor: not-allowed; } /* Make owned items not appear clickable */

        #cart-sidebar {
            width: 350px; flex-shrink: 0; background: var(--bg-secondary); padding: 1.5rem;
            border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
        }
        #cart-items { flex-grow: 1; display: flex; flex-direction: column; }
        #empty-cart-msg { color: var(--text-secondary); text-align: center; margin: auto 0; }
        #cart-summary { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 1rem; padding-top: 1rem; }
        #cart-summary div { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        #cart-total { font-size: 1.5rem; font-weight: bold; color: var(--nivra-gold); }
        
        /* --- Missions --- */
        .mission {
            background: var(--bg-secondary); padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1rem;
            display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1.5rem;
            border-left: 4px solid var(--text-secondary); transition: all 0.3s ease;
        }
        .mission.claimable { border-left-color: var(--nivra-gold); box-shadow: 0 0 15px rgba(247, 183, 51, 0.3); }
        .mission.claimed { border-left-color: var(--glow-color-1); opacity: 0.6; }
        .mission-icon { font-size: 2rem; width: 50px; text-align: center; }
        .mission.claimable .mission-icon { color: var(--nivra-gold); }
        .mission.claimed .mission-icon { color: var(--glow-color-1); }
        .mission-info p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }
        .mission-action .reward { font-weight: bold; color: var(--nivra-gold); display: block; text-align: right; margin-bottom: 0.5rem; }

        /* --- Fullscreen Lightbox for Media --- */
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; cursor: pointer; }
        #lightbox.active { display: flex; }
        #lightbox img, #lightbox video { max-width: 90vw; max-height: 90vh; cursor: default; }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            #market-container { flex-direction: column; }
            #cart-sidebar { width: 100%; margin-top: 2rem; max-width: none; }
            #main-content { flex-direction: column; overflow-y: auto; }
            #tab-nav { 
                flex-direction: row; border-right: none; border-bottom: 1px solid var(--border-color); 
                justify-content: flex-start; overflow-x: auto; padding: 0.5rem 1rem;
                -ms-overflow-style: none; scrollbar-width: none;
            }
            #tab-nav::-webkit-scrollbar { display: none; }
            .tab-btn { border-left: none; border-bottom: 4px solid transparent; flex-shrink: 0; text-align: center; }
            .tab-btn.active { border-left-color: transparent; border-bottom-color: var(--nivra-gold); }
        }

        @media (max-width: 767px) {
            #app-header { flex-direction: column; gap: 1rem; padding: 1rem; }
            .logo { font-size: 1.8rem; }
            #user-info { width: 100%; justify-content: space-between; }
            .tab-btn { font-size: 0.9rem; padding: 0.8rem; }
            #content-area { padding: 1rem; }
            #market-grid, #collection-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
            .item-name { font-size: 1rem; }
            .item-description { display: none; }
            .item-price { font-size: 1.1rem; }
            .modal-content { width: 90vw; }
            .mission { grid-template-columns: 1fr; text-align: center; gap: 1rem; }
            .mission-icon { margin: 0 auto; }
            .mission-action .reward { text-align: center; }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="full-screen-overlay">
        <h1 class="logo gradient-text" style="font-size: 4rem;">NIVRA World</h1>
        <p>Зареждане на вселената...</p>
    </div>
    <div id="login-required-screen" class="full-screen-overlay" style="display: none;">
        <h1 class="logo gradient-text">Достъп отказан</h1>
        <p>Трябва да влезете в профила си, за да влезете в NIVRA World.</p>
        <a href="index.html" class="btn btn-primary">Към Началната Страница</a>
    </div>

    <div id="app-container">
        <header id="app-header">
            <a href="index.html" style="text-decoration: none;"><h1 class="logo gradient-text">NIVRA World</h1></a>
            <div id="user-info">
                <div id="user-balance"><i class="fas fa-coins"></i> <span id="balance-amount">0</span></div>
                <button id="logout-btn" class="btn btn-secondary">Изход</button>
            </div>
        </header>

        <main id="main-content">
            <nav id="tab-nav">
                <button class="tab-btn active" data-tab="tab-market"><i class="fas fa-store"></i> Магазин</button>
                <button class="tab-btn" data-tab="tab-missions"><i class="fas fa-tasks"></i> Мисии</button>
                <button class="tab-btn" data-tab="tab-collection"><i class="fas fa-photo-video"></i> Моята Колекция</button>
            </nav>

            <div id="content-area">
                <!-- Market Tab -->
                <div id="tab-market" class="tab-panel active">
                    <div id="market-container">
                        <div id="market-grid"></div>
                        <aside id="cart-sidebar">
                            <h2><i class="fas fa-shopping-cart"></i> Количка</h2>
                            <div id="cart-items" style="list-style: none; padding: 0; margin: 1rem 0; min-height: 100px;">
                                <p id="empty-cart-msg" style="color: var(--text-secondary);">Количката е празна.</p>
                            </div>
                            <div id="cart-summary">
                                <div><strong style="font-size: 1.2rem;">Общо:</strong> <span id="cart-total">0</span></div>
                            </div>
                            <button id="buy-btn" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" disabled>
                                <span class="btn-text">Купи Сега</span>
                            </button>
                        </aside>
                    </div>
                </div>

                <!-- Missions Tab -->
                <div id="tab-missions" class="tab-panel">
                    <h2>Активни Мисии</h2>
                    <div id="missions-list" style="margin-top: 1.5rem;"></div>
                </div>

                <!-- Collection Tab -->
                <div id="tab-collection" class="tab-panel">
                    <h2>Моята Колекция</h2>
                    <div id="collection-grid" style="margin-top: 1.5rem;">
                        <p id="empty-collection-msg" style="color: var(--text-secondary);">Все още нямате закупени колекции.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="purchase-success-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal(this.closest('.modal-overlay'))"><i class="fas fa-times"></i></button>
             <div style="font-size: 4rem; color: var(--nivra-gold); margin-bottom: 1rem;"><i class="fas fa-check-circle"></i></div>
             <h2 class="gradient-text" style="font-family: var(--font-display);">Покупката е успешна!</h2>
             <p style="margin: 1rem 0;">Вашите нови колекции са добавени в "Моята Колекция".</p>
             <button class="btn btn-primary" style="position: static; margin-top: 1rem;" onclick="closeModal(this.closest('.modal-overlay'))">Супер!</button>
        </div>
    </div>
    
    <div id="lightbox" class="modal-overlay" onclick="closeModal(this)">
         <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <div id="lightbox-content" onclick="event.stopPropagation()"></div>
    </div>
    
    <div id="toast-container"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =================================================================================
        // == ДАННИ ЗА МАГАЗИНА И МИСИИТЕ (ЛЕСНО ЗА РЕДАКЦИЯ) ==
        // =================================================================================
        
        // OPTIMIZATION: Добавяме път до медийните файлове, за да е лесно за промяна.
        const MEDIA_PATH = ''; // Променете на 'assets/media/' ако файловете ви са в подпапка

        // За да добавиш нова колекция, просто копирай един от обектите и го промени.
        const MARKET_ITEMS = [
            { id: 'angel_1', name: 'Angel Vol. 1', price: 250, thumb: `${MEDIA_PATH}angel1.png`, type: 'collection', description: 'Съдържа 1 ексклузивно изображение и 6 уникални видеоклипа.', contents: { images: [`${MEDIA_PATH}angel1.png`], videos: [`${MEDIA_PATH}angel1_v1.webm`, `${MEDIA_PATH}angel1_v2.webm`, `${MEDIA_PATH}angel1_v3.webm`, `${MEDIA_PATH}angel1_v4.webm`, `${MEDIA_PATH}angel1_v5.webm`, `${MEDIA_PATH}angel1_v6.webm`] } },
            { id: 'angel_2', name: 'Angel Vol. 2', price: 250, thumb: `${MEDIA_PATH}angel2.png`, type: 'collection', description: 'Съдържа 1 ексклузивно изображение и 6 уникални видеоклипа.', contents: { images: [`${MEDIA_PATH}angel2.png`], videos: [`${MEDIA_PATH}angel2_v1.webm`, `${MEDIA_PATH}angel2_v2.webm`, `${MEDIA_PATH}angel2_v3.webm`, `${MEDIA_PATH}angel2_v4.webm`, `${MEDIA_PATH}angel2_v5.webm`, `${MEDIA_PATH}angel2_v6.webm`] } },
            { id: 'angel_3', name: 'Angel Vol. 3', price: 250, thumb: `${MEDIA_PATH}angel3.png`, type: 'collection', description: 'Съдържа 1 ексклузивно изображение и 6 уникални видеоклипа.', contents: { images: [`${MEDIA_PATH}angel3.png`], videos: [`${MEDIA_PATH}angel3_v1.webm`, `${MEDIA_PATH}angel3_v2.webm`, `${MEDIA_PATH}angel3_v3.webm`, `${MEDIA_PATH}angel3_v4.webm`, `${MEDIA_PATH}angel3_v5.webm`, `${MEDIA_PATH}angel3_v6.webm`] } },
            { id: 'az_pack', name: 'AZ Колекция', price: 400, thumb: `${MEDIA_PATH}az1.png`, type: 'image_pack', description: 'Пълен пакет, съдържащ 9 ексклузивни изображения.', contents: { images: [`${MEDIA_PATH}az1.png`, `${MEDIA_PATH}az2.png`, `${MEDIA_PATH}az3.png`, `${MEDIA_PATH}az4.png`, `${MEDIA_PATH}az5.png`, `${MEDIA_PATH}az6.png`, `${MEDIA_PATH}az7.png`, `${MEDIA_PATH}az8.png`, `${MEDIA_PATH}az9.png`], videos: [] } },
            { id: 'bandit_pack', name: 'Bandit Колекция', price: 400, thumb: `${MEDIA_PATH}bandit1.png`, type: 'image_pack', description: 'Пълен пакет, съдържащ 9 ексклузивни изображения.', contents: { images: [`${MEDIA_PATH}bandit1.png`, `${MEDIA_PATH}bandit2.png`, `${MEDIA_PATH}bandit3.png`, `${MEDIA_PATH}bandit4.png`, `${MEDIA_PATH}bandit5.png`, `${MEDIA_PATH}bandit6.png`, `${MEDIA_PATH}bandit7.png`, `${MEDIA_PATH}bandit8.png`, `${MEDIA_PATH}bandit9.png`], videos: [] } },
            { id: 'criminal_pack', name: 'Criminal Колекция', price: 400, thumb: `${MEDIA_PATH}criminal1.png`, type: 'image_pack', description: 'Пълен пакет, съдържащ 9 ексклузивни изображения.', contents: { images: [`${MEDIA_PATH}criminal1.png`, `${MEDIA_PATH}criminal2.png`, `${MEDIA_PATH}criminal3.png`, `${MEDIA_PATH}criminal4.png`, `${MEDIA_PATH}criminal5.png`, `${MEDIA_PATH}criminal6.png`, `${MEDIA_PATH}criminal7.png`, `${MEDIA_PATH}criminal8.png`, `${MEDIA_PATH}criminal9.png`], videos: [] } },
            { id: 'guz_pack', name: 'Guz Колекция', price: 400, thumb: `${MEDIA_PATH}guz1.png`, type: 'image_pack', description: 'Пълен пакет, съдържащ 9 ексклузивни изображения.', contents: { images: [`${MEDIA_PATH}guz1.png`, `${MEDIA_PATH}guz2.png`, `${MEDIA_PATH}guz3.png`, `${MEDIA_PATH}guz4.png`, `${MEDIA_PATH}guz5.png`, `${MEDIA_PATH}guz6.png`, `${MEDIA_PATH}guz7.png`, `${MEDIA_PATH}guz8.png`, `${MEDIA_PATH}guz9.png`], videos: [] } },
            { id: 'kur_pack', name: 'Kur Колекция', price: 400, thumb: `${MEDIA_PATH}kur1.png`, type: 'image_pack', description: 'Пълен пакет, съдържащ 9 ексклузивни изображения.', contents: { images: [`${MEDIA_PATH}kur1.png`, `${MEDIA_PATH}kur2.png`, `${MEDIA_PATH}kur3.png`, `${MEDIA_PATH}kur4.png`, `${MEDIA_PATH}kur5.png`, `${MEDIA_PATH}kur6.png`, `${MEDIA_PATH}kur7.png`, `${MEDIA_PATH}kur8.png`, `${MEDIA_PATH}kur9.png`], videos: [] } },
        ];
        
        const MISSIONS = [
            { id: 'buy_first', text: 'Новобранец', description: 'Направи първата си покупка', reward: 50, condition: (owned) => owned.length > 0 },
            { id: 'buy_3', text: 'Колекционер', description: 'Купи 3+ колекции', reward: 100, condition: (owned) => owned.length >= 3 },
            { id: 'own_all_angel', text: 'Ангелски допир', description: 'Притежавай всички "Angel" колекции', reward: 150, condition: (owned) => ['angel_1', 'angel_2', 'angel_3'].every(id => owned.includes(id))},
            { id: 'own_5', text: 'Мания', description: 'Притежавай 5+ колекции', reward: 200, condition: (owned) => owned.length >= 5 },
            { id: 'master_collector', text: 'Господар на Вселената', description: 'Притежавай всички колекции в магазина', reward: 1000, condition: (owned) => owned.length === MARKET_ITEMS.length }
        ];

        // =================================================================================
        // == КОД НА ПРИЛОЖЕНИЕТО ==
        // =================================================================================
        
        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.firebasestorage.app",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e736e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null, userDocRef: null, balance: 0,
            ownedItems: [], completedMissions: [], cart: [],
        };
        const dom = {
            loadingScreen: document.getElementById('loading-screen'),
            loginRequiredScreen: document.getElementById('login-required-screen'),
            appContainer: document.getElementById('app-container'),
            balanceAmount: document.getElementById('balance-amount'),
            marketGrid: document.getElementById('market-grid'),
            collectionGrid: document.getElementById('collection-grid'),
            emptyCollectionMsg: document.getElementById('empty-collection-msg'),
            cartItems: document.getElementById('cart-items'),
            emptyCartMsg: document.getElementById('empty-cart-msg'),
            cartTotal: document.getElementById('cart-total'),
            buyBtn: document.getElementById('buy-btn'),
            missionsList: document.getElementById('missions-list'),
            toastContainer: document.getElementById('toast-container'),
        };
        
        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                state.user = user;
                state.userDocRef = doc(db, 'users', user.uid);
                setupUserListener();
                initApp();
            } else {
                dom.loadingScreen.style.display = 'none';
                dom.loginRequiredScreen.style.display = 'flex';
            }
        });

        function setupUserListener() {
            onSnapshot(state.userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.balance = data.chips || 0;
                    state.ownedItems = data.collection || [];
                    state.completedMissions = data.completedMissions || [];
                    updateUI(); // Central function to update everything based on new data
                }
            });
        }
        
        function initApp() {
            dom.loadingScreen.style.opacity = '0';
            setTimeout(() => {
                dom.loadingScreen.style.display = 'none';
                dom.appContainer.style.display = 'flex';
            }, 500);
            
            renderMarket();
            setupEventListeners();
        }

        function updateUI() {
            dom.balanceAmount.textContent = state.balance.toLocaleString();
            updateAllItemStates();
            renderCollection();
            updateCart();
            renderMissions();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-star"></i> ${message}`;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function renderMarket() {
            dom.marketGrid.innerHTML = '';
            MARKET_ITEMS.forEach(item => {
                const card = document.createElement('div');
                card.className = 'market-item';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <img src="${item.thumb}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <p class="item-description">${item.description}</p>
                        <div class="item-price"><i class="fas fa-coins"></i> ${item.price}</div>
                    </div>
                    <div class="item-owned-overlay"><i class="fas fa-check-circle"></i> Притежавано</div>`;
                dom.marketGrid.appendChild(card);
            });
            updateAllItemStates(); // Ensure correct state on initial render
        }
        
        function renderCollection() {
            dom.collectionGrid.innerHTML = '';
            const ownedFullItems = MARKET_ITEMS.filter(item => state.ownedItems.includes(item.id));
            
            dom.emptyCollectionMsg.style.display = ownedFullItems.length === 0 ? 'block' : 'none';
            
            ownedFullItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'market-item';
                card.innerHTML = `<img src="${item.thumb}" alt="${item.name}" class="item-thumbnail"><div class="item-info"><div class="item-name">${item.name}</div></div>`;
                card.addEventListener('click', () => showLightbox(item));
                dom.collectionGrid.appendChild(card);
            });
        }

        function renderMissions() {
            dom.missionsList.innerHTML = '';
            MISSIONS.forEach(mission => {
                const isCompleted = state.completedMissions.includes(mission.id);
                const canComplete = mission.condition(state.ownedItems);

                let statusClass = '';
                let actionHtml = `<div class="reward">+${mission.reward} <i class="fas fa-coins"></i></div>`;

                if (isCompleted) {
                    statusClass = 'claimed';
                    actionHtml = `<button class="btn btn-secondary" disabled><i class="fas fa-check"></i> Прибрано</button>`;
                } else if (canComplete) {
                    statusClass = 'claimable';
                    actionHtml = `<button class="btn btn-primary claim-btn"><span class="btn-text">Прибери ${mission.reward}</span></button>`;
                }
                
                const missionEl = document.createElement('div');
                missionEl.className = `mission ${statusClass}`;
                missionEl.dataset.missionId = mission.id;
                missionEl.innerHTML = `
                    <div class="mission-icon"><i class="fas ${isCompleted ? 'fa-check-double' : 'fa-tasks'}"></i></div>
                    <div class="mission-info">
                        <strong>${mission.text}</strong>
                        <p>${mission.description}</p>
                    </div>
                    <div class="mission-action">${actionHtml}</div>`;
                dom.missionsList.appendChild(missionEl);
            });
        }

        async function handleClaimMission(missionId, button) {
            const mission = MISSIONS.find(m => m.id === missionId);
            if (!mission || state.completedMissions.includes(missionId) || !mission.condition(state.ownedItems)) return;
            
            toggleLoading(button, true);
            try {
                await updateDoc(state.userDocRef, {
                    chips: increment(mission.reward),
                    completedMissions: arrayUnion(missionId)
                });
                showToast(`Мисия изпълнена! +${mission.reward} точки!`);
            } catch (error) {
                console.error("Грешка при събиране на награда:", error);
                alert("Възникна грешка. Моля, опитайте отново.");
                toggleLoading(button, false); // Re-enable button on error
            }
            // On success, UI will auto-update via onSnapshot, no need to re-enable button manually
        }

        function updateAllItemStates() {
            document.querySelectorAll('.market-item[data-id]').forEach(card => {
                const id = card.dataset.id;
                const isOwned = state.ownedItems.includes(id);
                const isSelected = state.cart.some(cartItem => cartItem.id === id);
                card.classList.toggle('owned', isOwned);
                card.classList.toggle('selected', isSelected);
            });
        }

        function toggleCartItem(itemId) {
            if (state.ownedItems.includes(itemId)) return; // Double check not to add owned items

            const itemIndex = state.cart.findIndex(item => item.id === itemId);
            const itemData = MARKET_ITEMS.find(item => item.id === itemId);
            if (itemIndex > -1) { 
                state.cart.splice(itemIndex, 1); 
            } else { 
                state.cart.push({ id: itemData.id, name: itemData.name, price: itemData.price }); 
            }
            updateCart();
            updateAllItemStates();
        }

        function updateCart() {
            dom.cartItems.innerHTML = '';
            if (state.cart.length === 0) {
                dom.cartItems.innerHTML = '<p id="empty-cart-msg">Количката е празна.</p>';
                dom.cartTotal.textContent = '0';
                dom.buyBtn.disabled = true;
                return;
            }
            
            state.cart.forEach(item => {
                const li = document.createElement('li');
                li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;';
                li.innerHTML = `<span>${item.name}</span> <strong>${item.price}</strong>`;
                dom.cartItems.appendChild(li);
            });

            const total = state.cart.reduce((acc, item) => acc + item.price, 0);
            dom.cartTotal.textContent = total.toLocaleString();
            dom.buyBtn.disabled = state.balance < total;
        }

        async function handlePurchase() {
            const total = state.cart.reduce((acc, item) => acc + item.price, 0);
            if (state.balance < total || state.cart.length === 0) return;

            toggleLoading(dom.buyBtn, true);

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(state.userDocRef);
                    if (!userDoc.exists() || (userDoc.data().chips || 0) < total) {
                        throw "Недостатъчен баланс!";
                    }
                    const itemsToBuy = state.cart.map(item => item.id);
                    transaction.update(state.userDocRef, { 
                        chips: increment(-total),
                        collection: arrayUnion(...itemsToBuy)
                    });
                });
                
                state.cart = [];
                openModal(document.getElementById('purchase-success-modal'));
            } catch (error) {
                console.error("Грешка при транзакция: ", error);
                alert("Възникна грешка при покупката. Моля, проверете баланса си и опитайте отново.");
            } finally {
                toggleLoading(dom.buyBtn, false);
                // UI will auto-update via onSnapshot, including the cart and market items state
            }
        }
        
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.tab-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    document.querySelector('.tab-panel.active').classList.remove('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });

            // Logout and Purchase buttons
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            dom.buyBtn.addEventListener('click', handlePurchase);
            
            // FIX: Use event delegation for market items for better performance and to avoid stale listeners
            dom.marketGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.market-item');
                // Only toggle if the card exists and is not already owned
                if (card && !card.classList.contains('owned')) {
                    toggleCartItem(card.dataset.id);
                }
            });

            // Missions list claim buttons
            dom.missionsList.addEventListener('click', (e) => {
                const claimButton = e.target.closest('.claim-btn');
                if (claimButton) {
                    const missionId = claimButton.closest('.mission').dataset.missionId;
                    handleClaimMission(missionId, claimButton);
                }
            });
        }
        
        function showLightbox(item) {
            const lightbox = document.getElementById('lightbox');
            const contentContainer = document.getElementById('lightbox-content');
            
            // FIX: Prioritize video, then full image, then fallback to thumb
            const hasVideos = item.contents?.videos?.length > 0;
            const hasImages = item.contents?.images?.length > 0;

            if (hasVideos) {
                contentContainer.innerHTML = `<video src="${item.contents.videos[0]}" controls autoplay loop></video>`;
            } else if (hasImages) {
                // Show the first image from the collection, not the thumbnail
                contentContainer.innerHTML = `<img src="${item.contents.images[0]}" alt="${item.name}">`;
            } else {
                // Fallback if no specific content is defined
                contentContainer.innerHTML = `<img src="${item.thumb}" alt="${item.name}">`;
            }
            openModal(lightbox);
        }

        window.openModal = (modal) => modal.classList.add('active');
        window.closeModal = (modal) => { 
            if(!modal) return;
            modal.classList.remove('active');
            const video = modal.querySelector('video');
            if (video) { video.pause(); video.src = ''; }
        }

        function toggleLoading(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            if (isLoading) {
                button.disabled = true;
                if (btnText) btnText.style.display = 'none';
                if (!button.querySelector('.spinner')) {
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner';
                    button.prepend(spinner);
                }
            } else {
                button.disabled = false;
                if (btnText) btnText.style.display = 'inline-block';
                const spinner = button.querySelector('.spinner');
                if (spinner) spinner.remove();
            }
        }
    </script>
</body>
</html>

