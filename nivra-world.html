<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NIVRA World - Вашата ексклузивна колекция</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        
        :root {
            --neon-pink: #f9009a;
            --neon-cyan: #00f9f9;
            --neon-purple: #9d00f9;
            --dark-bg: #10081c;
            --border-color: rgba(0, 249, 249, 0.2);
        }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; /* Prevent scroll on main body */
        }

        body { 
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 1% 1%, rgba(157, 0, 249, 0.3), transparent 30%),
                radial-gradient(circle at 99% 99%, rgba(0, 249, 249, 0.2), transparent 30%);
            color: #e0e0e0;
            -webkit-font-smoothing: antialiased;
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        /* --- General UI Elements --- */
        .btn { padding: 0.6rem 1.5rem; border-radius: 9999px; font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase; transition: all 0.3s ease; border: 2px solid transparent; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-primary { background: linear-gradient(90deg, var(--neon-pink), var(--neon-purple)); color: white; box-shadow: 0 0 15px var(--neon-pink); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 0 25px var(--neon-pink); transform: scale(1.05); }
        .btn-primary:disabled { background: #4a4a6a; color: #8f8f8f; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; border-color: transparent; }
        .btn-secondary { background: transparent; border-color: var(--neon-cyan); color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan), inset 0 0 10px var(--neon-cyan); }
        .btn-secondary:hover:not(:disabled) { background: var(--neon-cyan); color: var(--dark-bg); box-shadow: 0 0 20px var(--neon-cyan); }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Main Layout --- */
        #app-container { display: none; flex-direction: column; width: 100%; height: 100%; position: relative; }
        #app-header {
            display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1.5rem;
            background: rgba(16, 8, 28, 0.8); backdrop-filter: blur(12px); z-index: 10;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 900; }
        #user-info { display: flex; align-items: center; gap: 1rem; }
        #user-balance { font-size: 1.1rem; font-weight: 600; font-family: 'Orbitron', sans-serif; color: var(--neon-cyan); display: flex; align-items: center; gap: 0.5rem; }
        #user-balance .fa-coins { animation: coin-pulse 2s infinite; color: var(--neon-cyan); }
        @keyframes coin-pulse { 0%, 100% { transform: scale(1); text-shadow: 0 0 5px var(--neon-cyan); } 50% { transform: scale(1.15); text-shadow: 0 0 15px var(--neon-cyan);} }
        #main-content { flex-grow: 1; display: flex; overflow: hidden; }

        /* --- Tabs --- */
        #tab-nav {
            display: flex; flex-direction: column; gap: 0.5rem; padding: 1.5rem 1rem;
            background: rgba(16, 8, 28, 0.7); border-right: 1px solid var(--border-color); flex-shrink: 0;
        }
        .tab-btn {
            font-family: 'Orbitron', sans-serif; font-size: 1rem; padding: 0.75rem 1.25rem; border-radius: 8px;
            color: #a0a0b0; cursor: pointer; text-align: left; white-space: nowrap;
            border-left: 4px solid transparent; transition: all 0.3s ease; background: none; border-right: none; border-top: none; border-bottom: none;
        }
        .tab-btn:hover { background: rgba(0, 249, 249, 0.1); color: var(--neon-cyan); }
        .tab-btn.active {
            background: rgba(249, 0, 154, 0.15); color: #fff;
            border-left-color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);
        }
        #content-area { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; }
        .tab-panel { display: none; animation: fadeIn 0.5s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Full Screen Overlays (Loading/Login) --- */
        .full-screen-overlay {
            position: fixed; inset: 0; background-color: var(--dark-bg); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2rem;
            transition: opacity 0.5s ease-out; text-align: center; padding: 1rem;
        }
        
        /* --- Marketplace & Collection Styles --- */
        #market-container { display: flex; gap: 1.5rem; }
        #market-grid, #collection-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .market-item {
            background: rgba(16, 8, 28, 0.7); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden;
            position: relative; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            display: flex; flex-direction: column; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .market-item:hover:not(.owned) { transform: translateY(-5px); border-color: var(--neon-pink); box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--neon-pink); }
        .market-item.selected { border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }
        .item-thumbnail { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .item-info { padding: 0.75rem; text-align: left; flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; margin-bottom: 0.25rem; }
        .item-description { font-size: 0.85rem; color: #a0a0b0; margin-bottom: 0.5rem; flex-grow: 1; line-height: 1.3; }
        .item-price { font-size: 1.2rem; font-weight: bold; color: var(--neon-cyan); text-align: right; font-family: 'Orbitron', sans-serif; }
        .item-owned-overlay {
            position: absolute; inset: 0; background: rgba(0, 249, 249, 0.6); backdrop-filter: blur(2px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--dark-bg);
            font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 900; text-align: center;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .market-item.owned .item-owned-overlay { opacity: 1; }
        .market-item.owned { cursor: default; }

        #cart-sidebar {
            width: 320px; flex-shrink: 0; background: rgba(16, 8, 28, 0.9); padding: 1.25rem;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
        }
        #cart-items { flex-grow: 1; display: flex; flex-direction: column; }
        #empty-cart-msg { color: #a0a0b0; text-align: center; margin: auto 0; }
        #cart-summary { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 1rem; padding-top: 1rem; }
        #cart-summary div { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        #cart-total { font-size: 1.4rem; font-weight: bold; color: var(--neon-cyan); font-family: 'Orbitron', sans-serif; }
        
        /* --- Missions --- */
        .mission {
            background: rgba(16, 8, 28, 0.7); padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1rem;
            display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1.25rem;
            border-left: 4px solid #4a4a6a; transition: all 0.3s ease;
        }
        .mission.claimable { border-left-color: var(--neon-pink); box-shadow: 0 0 15px rgba(249, 0, 154, 0.3); }
        .mission.claimed { border-left-color: var(--neon-cyan); opacity: 0.6; }
        .mission-icon { font-size: 1.8rem; width: 40px; text-align: center; }
        .mission.claimable .mission-icon { color: var(--neon-pink); }
        .mission.claimed .mission-icon { color: var(--neon-cyan); }
        .mission-info p { margin: 0; color: #a0a0b0; font-size: 0.9rem; }
        .mission-action .reward { font-weight: bold; color: var(--neon-cyan); display: block; text-align: right; margin-bottom: 0.5rem; font-family: 'Orbitron', sans-serif;}

        /* --- Modals & Lightbox --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            z-index: 9000; display: none; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: linear-gradient(145deg, #1c102f, #10081c); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px; box-shadow: 0 0 50px rgba(0,0,0,0.5); padding: 2rem;
            max-width: 90vw; width: 500px; text-align: center; position: relative;
        }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1.5rem; color: #a0a0b0; cursor: pointer; background: none; border: none; padding: 0.5rem; z-index: 10;}
        #lightbox-content { max-width: 90vw; max-height: 90vh; cursor: default; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; overflow-y: auto; padding: 1rem; background: rgba(0,0,0,0.5); border-radius: 12px;}
        #lightbox-content img, #lightbox-content video { width: 100%; height: auto; border-radius: 8px; }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            #main-content { flex-direction: column; }
            #tab-nav { 
                flex-direction: row; border-right: none; border-bottom: 1px solid var(--border-color); 
                justify-content: flex-start; overflow-x: auto; padding: 0.5rem;
                -ms-overflow-style: none; scrollbar-width: none;
            }
            #tab-nav::-webkit-scrollbar { display: none; }
            .tab-btn { border-left: none; border-bottom: 4px solid transparent; flex-shrink: 0; text-align: center; }
            .tab-btn.active { border-left-color: transparent; border-bottom-color: var(--neon-pink); }
            #market-container { flex-direction: column; }
            #cart-sidebar { width: 100%; margin-top: 1.5rem; max-width: none; }
        }

        @media (max-width: 767px) {
            body { font-size: 14px; }
            #app-header { flex-direction: column; gap: 0.75rem; padding: 0.75rem; }
            .logo { font-size: 1.5rem; }
            #user-info { width: 100%; justify-content: space-between; }
            .btn { padding: 0.5rem 1.2rem; font-size: 0.8rem; }
            .tab-btn { font-size: 0.8rem; padding: 0.6rem 0.8rem; }
            #content-area { padding: 1rem; }
            #market-grid, #collection-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
            .item-name { font-size: 0.9rem; }
            .item-description { display: none; }
            .item-price { font-size: 1rem; }
            .modal-content { width: 90vw; padding: 1.5rem; }
            .mission { grid-template-columns: 1fr; text-align: center; gap: 0.75rem; padding: 0.75rem; }
            .mission-icon { margin: 0 auto; }
            .mission-action .reward { text-align: center; }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="full-screen-overlay">
        <h1 class="logo gradient-text" style="font-size: 3rem;">NIVRA World</h1>
        <p>Зареждане на вселената...</p>
    </div>
    <div id="login-required-screen" class="full-screen-overlay" style="display: none;">
        <h1 class="logo gradient-text">Достъп отказан</h1>
        <p>Трябва да влезете в профила си, за да влезете в NIVRA World.</p>
        <a href="index.html" class="btn btn-primary">Към Началната Страница</a>
    </div>

    <div id="app-container">
        <header id="app-header">
            <a href="index.html" style="text-decoration: none;"><h1 class="logo gradient-text">NIVRA World</h1></a>
            <div id="user-info">
                <div id="user-balance"><i class="fas fa-coins"></i> <span id="balance-amount">0</span></div>
                <button id="logout-btn" class="btn btn-secondary !py-1.5 !px-3 !text-sm">Изход</button>
            </div>
        </header>

        <main id="main-content">
            <nav id="tab-nav">
                <button class="tab-btn active" data-tab="tab-market"><i class="fas fa-store mr-2"></i>Магазин</button>
                <button class="tab-btn" data-tab="tab-missions"><i class="fas fa-tasks mr-2"></i>Мисии</button>
                <button class="tab-btn" data-tab="tab-collection"><i class="fas fa-photo-video mr-2"></i>Колекция</button>
            </nav>

            <div id="content-area">
                <!-- Market Tab -->
                <div id="tab-market" class="tab-panel active">
                    <div id="market-container">
                        <div id="market-grid"></div>
                        <aside id="cart-sidebar">
                            <h2 class="text-xl font-bold font-['Orbitron']"><i class="fas fa-shopping-cart text-cyan-400"></i> Количка</h2>
                            <div id="cart-items" class="my-4 min-h-[100px]">
                                <p id="empty-cart-msg">Количката е празна.</p>
                            </div>
                            <div id="cart-summary">
                                <div><strong class="text-lg">Общо:</strong> <span id="cart-total">0</span></div>
                            </div>
                            <button id="buy-btn" class="btn btn-primary w-full mt-6" disabled>
                                <span class="btn-text">Купи Сега</span>
                            </button>
                        </aside>
                    </div>
                </div>

                <!-- Missions Tab -->
                <div id="tab-missions" class="tab-panel">
                    <h2 class="text-2xl font-bold font-['Orbitron'] mb-6">Активни Мисии</h2>
                    <div id="missions-list"></div>
                </div>

                <!-- Collection Tab -->
                <div id="tab-collection" class="tab-panel">
                    <h2 class="text-2xl font-bold font-['Orbitron'] mb-6">Моята Колекция</h2>
                    <div id="collection-grid">
                        <p id="empty-collection-msg" class="text-gray-400 col-span-full text-center">Все още нямате закупени колекции.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="purchase-success-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal(this.closest('.modal-overlay'))"><i class="fas fa-times"></i></button>
             <div class="text-6xl text-cyan-400 mb-4"><i class="fas fa-check-circle"></i></div>
             <h2 class="gradient-text text-2xl font-bold font-['Orbitron']">Покупката е успешна!</h2>
             <p class="my-4 text-gray-400">Вашите нови съкровища са добавени в "Колекция".</p>
             <button class="btn btn-primary mt-4" onclick="closeModal(this.closest('.modal-overlay'))">Разгледай</button>
        </div>
    </div>
    
    <div id="lightbox" class="modal-overlay" onclick="closeModal(this)">
        <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <div id="lightbox-content" onclick="event.stopPropagation()"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const MEDIA_PATH = ''; 

        const MARKET_ITEMS = [
            // ANGEL Packs
            { id: 'angel_1', name: 'Ангелски Шепот', price: 250, thumb: `${MEDIA_PATH}angel1.png`, description: 'Разкрий първата тайна. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel1.png`], videos: [`${MEDIA_PATH}angel1_v1.webm`,`${MEDIA_PATH}angel1_v2.webm`,`${MEDIA_PATH}angel1_v3.webm`,`${MEDIA_PATH}angel1_v4.webm`,`${MEDIA_PATH}angel1_v5.webm`,`${MEDIA_PATH}angel1_v6.webm`] } },
            { id: 'angel_2', name: 'Небесна Искра', price: 250, thumb: `${MEDIA_PATH}angel2.png`, description: 'Докосни се до светлината. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel2.png`], videos: [`${MEDIA_PATH}angel2_v1.webm`,`${MEDIA_PATH}angel2_v2.webm`,`${MEDIA_PATH}angel2_v3.webm`,`${MEDIA_PATH}angel2_v4.webm`,`${MEDIA_PATH}angel2_v5.webm`,`${MEDIA_PATH}angel2_v6.webm`] } },
            { id: 'angel_3', name: 'Паднали Пера', price: 250, thumb: `${MEDIA_PATH}angel3.png`, description: 'Открий забраненото. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel3.png`], videos: [`${MEDIA_PATH}angel3_v1.webm`,`${MEDIA_PATH}angel3_v2.webm`,`${MEDIA_PATH}angel3_v3.webm`,`${MEDIA_PATH}angel3_v4.webm`,`${MEDIA_PATH}angel3_v5.webm`,`${MEDIA_PATH}angel3_v6.webm`] } },
            { id: 'angel_4', name: 'Звезден Прах', price: 250, thumb: `${MEDIA_PATH}angel4.png`, description: 'Погледни отвъд воала. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel4.png`], videos: [`${MEDIA_PATH}angel4_v1.webm`,`${MEDIA_PATH}angel4_v2.webm`,`${MEDIA_PATH}angel4_v3.webm`,`${MEDIA_PATH}angel4_v4.webm`,`${MEDIA_PATH}angel4_v5.webm`,`${MEDIA_PATH}angel4_v6.webm`] } },
            { id: 'angel_5', name: 'Лунна Сянка', price: 250, thumb: `${MEDIA_PATH}angel5.png`, description: 'Танцувай с мрака. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel5.png`], videos: [`${MEDIA_PATH}angel5_v1.webm`,`${MEDIA_PATH}angel5_v2.webm`,`${MEDIA_PATH}angel5_v3.webm`,`${MEDIA_PATH}angel5_v4.webm`,`${MEDIA_PATH}angel5_v5.webm`,`${MEDIA_PATH}angel5_v6.webm`] } },
            { id: 'angel_6', name: 'Слънчев Лъч', price: 250, thumb: `${MEDIA_PATH}angel6.png`, description: 'Усети топлината. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel6.png`], videos: [`${MEDIA_PATH}angel6_v1.webm`,`${MEDIA_PATH}angel6_v2.webm`,`${MEDIA_PATH}angel6_v3.webm`,`${MEDIA_PATH}angel6_v4.webm`,`${MEDIA_PATH}angel6_v5.webm`,`${MEDIA_PATH}angel6_v6.webm`] } },
            { id: 'angel_7', name: 'Галактическо Ехо', price: 250, thumb: `${MEDIA_PATH}angel7.png`, description: 'Чуй песента на космоса. Съдържа 1 изображение и 6 видеа.', contents: { images: [`${MEDIA_PATH}angel7.png`], videos: [`${MEDIA_PATH}angel7_v1.webm`,`${MEDIA_PATH}angel7_v2.webm`,`${MEDIA_PATH}angel7_v3.webm`,`${MEDIA_PATH}angel7_v4.webm`,`${MEDIA_PATH}angel7_v5.webm`,`${MEDIA_PATH}angel7_v6.webm`] } },
            { id: 'angel_8', name: 'Кристална Сълза', price: 250, thumb: `${MEDIA_PATH}angel8.png`, description: 'Виж чистата емоция. Съдържа 1 изображение и 2 видеа.', contents: { images: [`${MEDIA_PATH}angel8.png`], videos: [`${MEDIA_PATH}angel8_v1.webm`,`${MEDIA_PATH}angel8_v2.webm`] } },
            { id: 'angel_9', name: 'Огнен Порив', price: 250, thumb: `${MEDIA_PATH}angel9.png`, description: 'Изживей страстта. Съдържа 1 изображение и 5 видеа.', contents: { images: [`${MEDIA_PATH}angel9.png`], videos: [`${MEDIA_PATH}angel9_v1.webm`,`${MEDIA_PATH}angel9_v2.webm`,`${MEDIA_PATH}angel9_v3.webm`,`${MEDIA_PATH}angel9_v4.webm`,`${MEDIA_PATH}angel9_v5.webm`] } },
            
            // AZ Pack
            { id: 'az_pack', name: 'Лазурен Пламък', price: 500, thumb: `${MEDIA_PATH}az1.png`, description: 'Колекция от 9 видеа и 9 изображения, изгарящи с мистична енергия.', contents: { images: [`${MEDIA_PATH}az1.png`,`${MEDIA_PATH}az2.png`,`${MEDIA_PATH}az3.png`,`${MEDIA_PATH}az4.png`,`${MEDIA_PATH}az5.png`,`${MEDIA_PATH}az6.png`,`${MEDIA_PATH}az7.png`,`${MEDIA_PATH}az8.png`,`${MEDIA_PATH}az9.png`], videos: [`${MEDIA_PATH}az1_v1.webm`,`${MEDIA_PATH}az2_v1.webm`,`${MEDIA_PATH}az3_v1.webm`,`${MEDIA_PATH}az4_v1.webm`,`${MEDIA_PATH}az5_v1.webm`,`${MEDIA_PATH}az6_v1.webm`,`${MEDIA_PATH}az7_v1.webm`,`${MEDIA_PATH}az8_v1.webm`,`${MEDIA_PATH}az9_v1.webm`] } },
            
            // Bandit Pack
            { id: 'bandit_pack', name: 'Неонов Разбойник', price: 400, thumb: `${MEDIA_PATH}bandit1.png`, description: 'Пакет от 9 дръзки изображения от сенките на кибер-града.', contents: { images: [`${MEDIA_PATH}bandit1.png`,`${MEDIA_PATH}bandit2.png`,`${MEDIA_PATH}bandit3.png`,`${MEDIA_PATH}bandit4.png`,`${MEDIA_PATH}bandit5.png`,`${MEDIA_PATH}bandit6.png`,`${MEDIA_PATH}bandit7.png`,`${MEDIA_PATH}bandit8.png`,`${MEDIA_PATH}bandit9.png`], videos: [] } },
            
            // Criminal Pack
            { id: 'criminal_pack', name: 'Пурпурен Синдикат', price: 500, thumb: `${MEDIA_PATH}criminal1.png`, description: '9 видеа и 9 изображения от тайния свят на престъпния елит.', contents: { images: [`${MEDIA_PATH}criminal1.png`,`${MEDIA_PATH}criminal2.png`,`${MEDIA_PATH}criminal3.png`,`${MEDIA_PATH}criminal4.png`,`${MEDIA_PATH}criminal5.png`,`${MEDIA_PATH}criminal6.png`,`${MEDIA_PATH}criminal7.png`,`${MEDIA_PATH}criminal8.png`,`${MEDIA_PATH}criminal9.png`], videos: [`${MEDIA_PATH}criminal1_v1.webm`,`${MEDIA_PATH}criminal2_v1.webm`,`${MEDIA_PATH}criminal3_v1.webm`,`${MEDIA_PATH}criminal4_v1.webm`,`${MEDIA_PATH}criminal5_v1.webm`,`${MEDIA_PATH}criminal6_v1.webm`,`${MEDIA_PATH}criminal7_v1.webm`,`${MEDIA_PATH}criminal8_v1.webm`,`${MEDIA_PATH}criminal9_v1.webm`] } },
            
            // Guz Pack
            { id: 'guz_pack', name: 'Обсидианов Поглед', price: 400, thumb: `${MEDIA_PATH}guz1.png`, description: 'Колекция от 9 хипнотизиращи изображения, по-тъмни от нощта.', contents: { images: [`${MEDIA_PATH}guz1.png`,`${MEDIA_PATH}guz2.png`,`${MEDIA_PATH}guz3.png`,`${MEDIA_PATH}guz4.png`,`${MEDIA_PATH}guz5.png`,`${MEDIA_PATH}guz6.png`,`${MEDIA_PATH}guz7.png`,`${MEDIA_PATH}guz8.png`,`${MEDIA_PATH}guz9.png`], videos: [] } },
            
            // Kur Pack
            { id: 'kur_pack', name: 'Забранена Реликва', price: 500, thumb: `${MEDIA_PATH}kur1.png`, description: 'Колекция от видеа и 9 изображения, които не е трябвало да виждаш.', contents: { images: [`${MEDIA_PATH}kur1.png`,`${MEDIA_PATH}kur2.png`,`${MEDIA_PATH}kur3.png`,`${MEDIA_PATH}kur4.png`,`${MEDIA_PATH}kur5.png`,`${MEDIA_PATH}kur6.png`,`${MEDIA_PATH}kur7.png`,`${MEDIA_PATH}kur8.png`,`${MEDIA_PATH}kur9.png`], videos: [`${MEDIA_PATH}kur1_v1.webm`,`${MEDIA_PATH}kur3_v1.webm`,`${MEDIA_PATH}kur4_v1.webm`,`${MEDIA_PATH}kur6_v1.webm`] } },
            
            // LOL Pack
            { id: 'lol_pack', name: 'Призрачен Смях', price: 500, thumb: `${MEDIA_PATH}lol1.png`, description: 'Колекция от видеа и 9 изображения, които ще те накарат да се усъмниш в реалността.', contents: { images: [`${MEDIA_PATH}lol1.png`,`${MEDIA_PATH}lol2.png`,`${MEDIA_PATH}lol3.png`,`${MEDIA_PATH}lol4.png`,`${MEDIA_PATH}lol5.png`,`${MEDIA_PATH}lol6.png`,`${MEDIA_PATH}lol7.png`,`${MEDIA_PATH}lol8.png`,`${MEDIA_PATH}lol9.png`], videos: [`${MEDIA_PATH}lol1_v1.webm`,`${MEDIA_PATH}lol2_v1.webm`,`${MEDIA_PATH}lol3_v1.webm`,`${MEDIA_PATH}lol4_v1.webm`,`${MEDIA_PATH}lol5_v1.webm`,`${MEDIA_PATH}lol6_v1.webm`,`${MEDIA_PATH}lol7_v1.webm`,`${MEDIA_PATH}lol9_v1.webm`] } },
             
             // N Pack
            { id: 'n_pack', name: 'Ноктюрно Девет', price: 400, thumb: `${MEDIA_PATH}n1.png`, description: 'Симфония от 9 изображения, родени в мрака.', contents: { images: [`${MEDIA_PATH}n1.png`,`${MEDIA_PATH}n2.png`,`${MEDIA_PATH}n3.png`,`${MEDIA_PATH}n4.png`,`${MEDIA_PATH}n5.png`,`${MEDIA_PATH}n6.png`,`${MEDIA_PATH}n7.png`,`${MEDIA_PATH}n8.png`,`${MEDIA_PATH}n9.png`], videos: [] } },

            // RUB Pack
            { id: 'rub_pack', name: 'Рубинен Резонанс', price: 500, thumb: `${MEDIA_PATH}rub1.png`, description: 'Вибрации в червено. Колекция от видеа и 9 изображения.', contents: { images: [`${MEDIA_PATH}rub1.png`,`${MEDIA_PATH}rub2.png`,`${MEDIA_PATH}rub3.png`,`${MEDIA_PATH}rub4.png`,`${MEDIA_PATH}rub5.png`,`${MEDIA_PATH}rub6.png`,`${MEDIA_PATH}rub7.png`,`${MEDIA_PATH}rub8.png`,`${MEDIA_PATH}rub9.png`], videos: [`${MEDIA_PATH}rub2_v1.webm`,`${MEDIA_PATH}rub3_v1.webm`,`${MEDIA_PATH}rub5_v1.webm`,`${MEDIA_PATH}rub6_v1.webm`] } },
        ];
        
        const MISSIONS = [
            { id: 'buy_first', text: 'Новобранец', description: 'Направи първата си покупка', reward: 50, condition: (owned) => owned.length > 0 },
            { id: 'buy_3', text: 'Колекционер', description: 'Купи 3+ колекции', reward: 100, condition: (owned) => owned.length >= 3 },
            { id: 'own_all_angel', text: 'Ангелски Допир', description: 'Притежавай всички "Angel" колекции', reward: 250, condition: (owned) => ['angel_1', 'angel_2', 'angel_3', 'angel_4', 'angel_5', 'angel_6', 'angel_7', 'angel_8', 'angel_9'].every(id => owned.includes(id))},
            { id: 'buy_10', text: 'Мания', description: 'Притежавай 10+ колекции', reward: 300, condition: (owned) => owned.length >= 10 },
            { id: 'master_collector', text: 'Господар на Вселената', description: 'Притежавай всички колекции в магазина', reward: 1000, condition: (owned) => owned.length === MARKET_ITEMS.length }
        ];

        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.appspot.com",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e736e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = { user: null, userDocRef: null, balance: 0, ownedItems: [], completedMissions: [], cart: [] };
        const dom = {
            loadingScreen: document.getElementById('loading-screen'),
            loginRequiredScreen: document.getElementById('login-required-screen'),
            appContainer: document.getElementById('app-container'),
            balanceAmount: document.getElementById('balance-amount'),
            marketGrid: document.getElementById('market-grid'),
            collectionGrid: document.getElementById('collection-grid'),
            emptyCollectionMsg: document.getElementById('empty-collection-msg'),
            cartItems: document.getElementById('cart-items'),
            cartTotal: document.getElementById('cart-total'),
            buyBtn: document.getElementById('buy-btn'),
            missionsList: document.getElementById('missions-list'),
        };
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await user.reload(); // Always get the latest user state
                const refreshedUser = auth.currentUser;
                if (refreshedUser && refreshedUser.emailVerified) {
                    state.user = refreshedUser;
                    state.userDocRef = doc(db, 'users', refreshedUser.uid);
                    setupUserListener();
                    initApp();
                } else {
                    showLoginRequired();
                }
            } else {
                showLoginRequired();
            }
        });

        function showLoginRequired() {
            dom.loadingScreen.style.display = 'none';
            dom.loginRequiredScreen.style.display = 'flex';
        }

        function setupUserListener() {
            onSnapshot(state.userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.balance = data.chips || 0;
                    state.ownedItems = data.collection || [];
                    state.completedMissions = data.completedMissions || [];
                    updateUI();
                }
            });
        }
        
        function initApp() {
            dom.loadingScreen.style.opacity = '0';
            setTimeout(() => {
                dom.loadingScreen.style.display = 'none';
                dom.appContainer.style.display = 'flex';
            }, 500);
            renderMarket();
            setupEventListeners();
        }

        function updateUI() {
            dom.balanceAmount.textContent = state.balance.toLocaleString('bg-BG');
            updateAllItemStates();
            renderCollection();
            updateCart();
            renderMissions();
        }

        function renderMarket() {
            dom.marketGrid.innerHTML = '';
            MARKET_ITEMS.forEach(item => {
                const card = document.createElement('div');
                card.className = 'market-item';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <img src="${item.thumb}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <p class="item-description">${item.description}</p>
                        <div class="item-price"><i class="fas fa-coins"></i> ${item.price}</div>
                    </div>
                    <div class="item-owned-overlay"><i class="fas fa-check-circle"></i> Притежавано</div>`;
                dom.marketGrid.appendChild(card);
            });
            updateAllItemStates();
        }
        
        function renderCollection() {
            const ownedFullItems = MARKET_ITEMS.filter(item => state.ownedItems.includes(item.id));
            dom.emptyCollectionMsg.style.display = ownedFullItems.length === 0 ? 'block' : 'none';
            if (ownedFullItems.length > 0) {
                 dom.collectionGrid.innerHTML = '';
                 ownedFullItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'market-item !cursor-pointer'; // Add !cursor-pointer to override owned style
                    card.innerHTML = `<img src="${item.thumb}" alt="${item.name}" class="item-thumbnail"><div class="item-info"><div class="item-name">${item.name}</div></div>`;
                    card.addEventListener('click', () => showLightbox(item));
                    dom.collectionGrid.appendChild(card);
                });
            }
        }

        function renderMissions() {
            dom.missionsList.innerHTML = '';
            MISSIONS.forEach(mission => {
                const isCompleted = state.completedMissions.includes(mission.id);
                const canComplete = mission.condition(state.ownedItems);
                let statusClass = '';
                let actionHtml = `<div class="reward">+${mission.reward} <i class="fas fa-coins"></i></div>`;
                if (isCompleted) {
                    statusClass = 'claimed';
                    actionHtml = `<button class="btn btn-secondary" disabled><i class="fas fa-check"></i> Прибрано</button>`;
                } else if (canComplete) {
                    statusClass = 'claimable';
                    actionHtml = `<button class="btn btn-primary claim-btn"><span class="btn-text">Прибери</span></button>`;
                }
                const missionEl = document.createElement('div');
                missionEl.className = `mission ${statusClass}`;
                missionEl.dataset.missionId = mission.id;
                missionEl.innerHTML = `
                    <div class="mission-icon"><i class="fas ${isCompleted ? 'fa-check-double' : 'fa-trophy'}"></i></div>
                    <div class="mission-info"><strong>${mission.text}</strong><p>${mission.description}</p></div>
                    <div class="mission-action">${actionHtml}</div>`;
                dom.missionsList.appendChild(missionEl);
            });
        }

        async function handleClaimMission(missionId, button) {
            const mission = MISSIONS.find(m => m.id === missionId);
            if (!mission || state.completedMissions.includes(missionId) || !mission.condition(state.ownedItems)) return;
            toggleLoading(button, true);
            try {
                // Using runTransaction for claiming missions is safer
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(state.userDocRef);
                    if (!userDoc.exists()) throw "User not found";
                    
                    const completed = userDoc.data().completedMissions || [];
                    if (completed.includes(missionId)) return; // Already claimed

                    transaction.update(state.userDocRef, {
                        chips: increment(mission.reward),
                        completedMissions: arrayUnion(missionId)
                    });
                });
            } catch (error) {
                console.error("Error claiming mission:", error);
                alert("Възникна грешка. Моля, опитайте отново.");
                toggleLoading(button, false);
            }
        }

        function updateAllItemStates() {
            document.querySelectorAll('.market-item[data-id]').forEach(card => {
                const id = card.dataset.id;
                const isOwned = state.ownedItems.includes(id);
                const isSelected = state.cart.some(cartItem => cartItem.id === id);
                card.classList.toggle('owned', isOwned);
                card.classList.toggle('selected', isSelected);
            });
        }

        function toggleCartItem(itemId) {
            if (state.ownedItems.includes(itemId)) return;
            const itemIndex = state.cart.findIndex(item => item.id === itemId);
            const itemData = MARKET_ITEMS.find(item => item.id === itemId);
            if (itemIndex > -1) { state.cart.splice(itemIndex, 1); } 
            else { state.cart.push({ id: itemData.id, name: itemData.name, price: itemData.price }); }
            updateCart();
            updateAllItemStates();
        }

        function updateCart() {
            if (state.cart.length === 0) {
                dom.cartItems.innerHTML = '<p id="empty-cart-msg">Количката е празна.</p>';
                dom.cartTotal.textContent = '0';
                dom.buyBtn.disabled = true;
            } else {
                dom.cartItems.innerHTML = state.cart.map(item => 
                    `<div class="flex justify-between items-center mb-2 text-sm">
                        <span>${item.name}</span> 
                        <strong class="font-['Orbitron'] text-cyan-400">${item.price}</strong>
                    </div>`
                ).join('');
            }
            const total = state.cart.reduce((acc, item) => acc + item.price, 0);
            dom.cartTotal.textContent = total.toLocaleString('bg-BG');
            dom.buyBtn.disabled = state.balance < total || total === 0;
        }

        async function handlePurchase() {
            const total = state.cart.reduce((acc, item) => acc + item.price, 0);
            if (state.balance < total || state.cart.length === 0) return;
            toggleLoading(dom.buyBtn, true);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(state.userDocRef);
                    if (!userDoc.exists()) throw "User document does not exist!";
                    
                    const newBalance = userDoc.data().chips - total;
                    if (newBalance < 0) throw "Insufficient funds!";
                    
                    const itemsToBuy = state.cart.map(item => item.id);
                    transaction.update(state.userDocRef, { 
                        chips: newBalance,
                        collection: arrayUnion(...itemsToBuy)
                    });
                });
                state.cart = [];
                openModal(document.getElementById('purchase-success-modal'));
            } catch (error) {
                console.error("Purchase Transaction failed: ", error);
                alert(`Грешка при покупка: ${error}. Моля, опитайте отново.`);
            } finally {
                toggleLoading(dom.buyBtn, false);
                // UI will be updated by the onSnapshot listener automatically
            }
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelector('.tab-btn.active').classList.remove('active');
                btn.classList.add('active');
                document.querySelector('.tab-panel.active').classList.remove('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            }));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            dom.buyBtn.addEventListener('click', handlePurchase);
            dom.marketGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.market-item');
                if (card && !card.classList.contains('owned')) {
                    toggleCartItem(card.dataset.id);
                }
            });
            dom.missionsList.addEventListener('click', (e) => {
                const claimButton = e.target.closest('.claim-btn');
                if (claimButton) {
                    const missionId = claimButton.closest('.mission').dataset.missionId;
                    handleClaimMission(missionId, claimButton);
                }
            });
        }
        
        function showLightbox(item) {
            const lightbox = document.getElementById('lightbox');
            const contentContainer = document.getElementById('lightbox-content');
            contentContainer.innerHTML = '';
            
            item.contents.images.forEach(src => {
                contentContainer.innerHTML += `<img src="${src}" alt="image content">`;
            });
            item.contents.videos.forEach(src => {
                contentContainer.innerHTML += `<video src="${src}" controls loop playsinline></video>`;
            });
            openModal(lightbox);
        }

        window.openModal = (modal) => modal.classList.add('active');
        window.closeModal = (modal) => { 
            if(!modal) return;
            modal.classList.remove('active');
            modal.querySelectorAll('video').forEach(video => {
                video.pause();
                video.src = '';
            });
        }

        function toggleLoading(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            if (isLoading) {
                button.disabled = true;
                if (btnText) btnText.style.display = 'none';
                if (!button.querySelector('.spinner')) {
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner';
                    button.prepend(spinner);
                }
            } else {
                button.disabled = false;
                if (btnText) btnText.style.display = 'inline-block';
                button.querySelector('.spinner')?.remove();
            }
        }
    </script>
</body>
</html>
