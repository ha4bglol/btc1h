<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mines Diamond Finder (25/16)</title>
<style>
  :root {
    --bg-color: #1a1f36;
    --panel-bg: #2a314d;
    --cell-bg: #3d426b;
    --cell-hover-bg: #4a517b;
    --text-color: #e0e0e0;
    --text-color-light: #aaa;
    --mine-color: #ff5555;
    --safe-color-rgba: 76, 175, 80; /* Зелен цвят за диаманти в RGBA формат */
  }
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 24px;
    background: var(--bg-color);
    color: var(--text-color);
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }
  .container {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .panel { 
    background: var(--panel-bg); 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  h1 { font-size: 22px; margin-top: 0; text-align: center; }
  .info { font-size: 14px; color: var(--text-color-light); text-align: center; margin-top: -10px; margin-bottom: 20px; }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }
  .cell {
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    font-weight: bold;
    font-size: 16px;
    transition: background-color 0.2s, transform 0.1s;
    background-color: var(--cell-bg);
  }
  .cell:hover { background-color: var(--cell-hover-bg); transform: scale(1.05); }
  .cell:active { transform: scale(0.98); }
  .cell.selected-mine { background: var(--mine-color); color: white; }
  
  #controls { display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
  button {
    background-color: var(--cell-bg);
    color: white;
    border: none;
    padding: 12px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: background-color 0.2s;
  }
  button:hover { background-color: var(--cell-hover-bg); }
  button:disabled { background-color: #333; color: #777; cursor: not-allowed; }

  #stats-panel { width: 360px; }
  #stats { line-height: 1.7; }
  #historyList { font-size: 13px; color:var(--text-color-light); max-height: 200px; overflow-y: auto; padding-right: 10px; }
  hr { border-color: #444; margin: 16px 0; }
</style>
</head>
<body>

<div class="container">
    
    <div class="panel">
        <h1>Търсач на диаманти (25 полета / 16 мини)</h1>
        <p class="info">Кликнете върху 16-те полета с бомби, за да добавите рунд в историята.</p>
        <div id="gridContainer"></div>
        <div id="controls">
            <span id="manualModeStatus" class="info" style="font-weight: bold; height: 20px;"></span>
            <button id="confirmManual" disabled>Потвърди рунд (16 бомби)</button>
            <button id="clearHistory">Изчисти историята</button>
        </div>
    </div>

    <div id="stats-panel" class="panel">
        <h2>Анализ и статистика</h2>
        <strong>Топ кандидати за диаманти:</strong>
        <div id="stats" style="margin-top:8px; font-size: 14px;"></div>
        <hr>
        <strong>История (последни <span id="baseSize">10</span> рунда):</strong>
        <div id="historyList" style="margin-top:8px;"></div>
    </div>

</div>

<script>
(function(){
  // --- Фиксирани параметри на играта ---
  const T = 25; // Общо полета
  const M = 16; // Брой бомби/мини
  const base = 10; // База за анализ (последни 10 рунда)

  let rounds = []; // Масив от рундове; всеки рунд е масив с дължина T, стойности 0/1 (1 = мина)
  let manualSelection = new Set();

  const gridContainer = document.getElementById('gridContainer');
  const statsDiv = document.getElementById('stats');
  const historyList = document.getElementById('historyList');
  const statusSpan = document.getElementById('manualModeStatus');
  const confirmBtn = document.getElementById('confirmManual');
  const clearBtn = document.getElementById('clearHistory');

  function render() {
    gridContainer.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'grid';
    
    // 1. Изчисляваме честотата на МИНИТЕ, за да намерим честотата на ДИАМАНТИТЕ
    const mineCounts = new Array(T).fill(0);
    const totalRoundsInHistory = rounds.length;
    
    for (const r of rounds) {
      for (let i = 0; i < T; i++) {
        if (r[i] === 1) mineCounts[i]++;
      }
    }

    // 2. Рендираме клетките
    for (let i = 0; i < T; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.textContent = i;
      
      if (manualSelection.has(i)) {
        cell.classList.add('selected-mine');
      } else {
        // Оцветяване според вероятността да е ДИАМАНТ
        if (totalRoundsInHistory > 0) {
          const safeCount = totalRoundsInHistory - mineCounts[i];
          const safeProbability = safeCount / totalRoundsInHistory;
          
          if (safeProbability > 0) {
            cell.title = `Диамант: ${safeCount} / ${totalRoundsInHistory} (${(safeProbability * 100).toFixed(0)}%)`;
            const intensity = Math.min(1, safeProbability * 1.5);
            cell.style.backgroundColor = `rgba(var(--safe-color-rgba), ${intensity})`;
          } else {
             cell.title = `Никога не е бил диамант досега (в текущата история)`;
          }
        }
      }

      cell.onclick = () => handleCellClick(i, cell);
      grid.appendChild(cell);
    }
    gridContainer.appendChild(grid);

    // 3. Обновяваме статистики и история
    displayStats(mineCounts, totalRoundsInHistory);
    renderHistory();
    updateManualStatus();
    document.getElementById('baseSize').textContent = base;
  }
  
  function handleCellClick(index, cellElement) {
    if (manualSelection.has(index)) {
      manualSelection.delete(index);
      cellElement.classList.remove('selected-mine');
    } else {
      if (manualSelection.size < M) {
        manualSelection.add(index);
        cellElement.classList.add('selected-mine');
      }
    }
    render(); // Прерисуваме всичко, за да се обновят цветовете веднага
  }

  function updateManualStatus() {
    const selectedCount = manualSelection.size;
    if (selectedCount < M) {
        statusSpan.textContent = `Изберете още ${M - selectedCount} бомби`;
    } else {
        statusSpan.textContent = `Готови за потвърждение!`;
    }
    confirmBtn.disabled = selectedCount !== M;
  }
  
  function displayStats(mineCounts, totalRounds) {
    if (totalRounds === 0) {
      statsDiv.innerHTML = 'Няма данни. Въведете рунд, за да започне анализът.';
      return;
    }
    
    // Преобразуваме честотата на мините в честота на диамантите
    const safeCandidates = mineCounts.map((count, index) => ({
      i: index,
      safeCount: totalRounds - count,
      safeProb: (totalRounds - count) / totalRounds
    }));
    
    // Сортираме по брой пъти "диамант" (safeCount) в намаляващ ред
    safeCandidates.sort((a, b) => b.safeCount - a.safeCount);
    
    const topCandidates = safeCandidates.slice(0, 9); // Показваме топ 9 (колкото са диамантите)
    
    statsDiv.innerHTML = '';
    const list = document.createElement('div');
    topCandidates.forEach(candidate => {
      const row = document.createElement('div');
      row.innerHTML = `<strong>Клетка ${candidate.i}</strong> &rarr; ${candidate.safeCount}/${totalRounds} пъти (${(candidate.safeProb * 100).toFixed(0)}%)`;
      list.appendChild(row);
    });
    statsDiv.appendChild(list);
  }
  
  function renderHistory() {
    historyList.innerHTML = '';
    if (rounds.length === 0) {
        historyList.innerHTML = 'Няма въведени рундове.';
        return;
    }
    [...rounds].reverse().forEach((r, idx) => {
      const div = document.createElement('div');
      const mines = r.map((val, i) => val ? i : null).filter(x => x !== null);
      div.textContent = `Рунд #${rounds.length - idx}: Мини на ${mines.join(', ')}`;
      historyList.appendChild(div);
    });
  }

  function pushRound(roundArray) {
    rounds.push(roundArray);
    if (rounds.length > base) {
      rounds.shift(); // Поддържаме само последните 'base' рунда
    }
  }

  // --- Event Handlers ---
  confirmBtn.onclick = () => {
    if (manualSelection.size !== M) return;
    
    const newRound = new Array(T).fill(0);
    for (const mineIndex of manualSelection) {
      newRound[mineIndex] = 1;
    }
    
    pushRound(newRound);
    manualSelection.clear();
    render();
  };
  
  clearBtn.onclick = () => {
    rounds = [];
    manualSelection.clear();
    render();
  };

  // Initial render on page load
  render();

})();
</script>
</body>
</html>
