<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVRA - Мини</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --neon-pink: #f9009a;
            --neon-cyan: #00f9f9;
            --neon-purple: #9d00f9;
            --dark-bg: #10081c;
        }
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 1% 1%, rgba(157, 0, 249, 0.3), transparent 30%),
                radial-gradient(circle at 99% 99%, rgba(0, 249, 249, 0.2), transparent 30%);
            color: #e0e0e0;
            overflow-x: hidden;
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .btn-action {
            padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase; transition: all 0.3s ease;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-purple)); color: white; box-shadow: 0 0 15px var(--neon-pink); border: none;
        }
        .btn-action:hover:not(:disabled) {
            box-shadow: 0 0 25px var(--neon-pink), 0 0 40px var(--neon-purple); transform: translateY(-2px) scale(1.05);
        }
        .btn-action:disabled {
            background: #4a4a6a; color: #8f8f8f; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none;
        }
        .form-input { 
            background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 12px; padding: 0.8rem 1rem; width: 100%; transition: all 0.3s ease;
        }
        .form-input:focus { 
            outline: none; border-color: var(--neon-cyan); background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 15px rgba(0, 249, 249, 0.2); 
        }
        .mines-tile {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); transition: all 0.15s ease; aspect-ratio: 1 / 1;
        }
        .mines-tile:not(:disabled):hover {
            background: rgba(0,0,0,0.5); border-color: var(--neon-cyan); transform: scale(1.05);
        }
        .mines-tile.safe {
            background: var(--neon-cyan); color: var(--dark-bg); border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan), inset 0 0 10px rgba(255,255,255,0.5); transform: scale(1.05); font-size: 1.5rem;
        }
        .mines-tile.mine {
            background: var(--neon-pink); color: white; border-color: var(--neon-pink); box-shadow: 0 0 15px var(--neon-pink), inset 0 0 10px rgba(255,255,255,0.5); transform: scale(1.05); font-size: 1.5rem;
        }
        .mines-tile:disabled { cursor: not-allowed; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .video-container {
            border: 2px solid; border-image-slice: 1; border-image-source: linear-gradient(to bottom, var(--neon-cyan), var(--neon-pink));
            box-shadow: 0 0 20px rgba(0, 249, 249, 0.3), 0 0 20px rgba(249, 0, 154, 0.3);
            overflow: hidden; border-radius: 1rem;
            position: relative; /* Нужно за позиционирането на видеата */
        }
        .video-container .video-player {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease-in-out; /* Плавна смяна */
        }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-40 shadow-lg" style="background: rgba(16, 8, 28, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold gradient-text flex-shrink-0" style="font-family: 'Orbitron', sans-serif;">NIVRA</a>
            <a href="index.html" class="text-gray-300 hover:text-cyan-400 transition text-lg font-semibold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span class="hidden sm:inline">Обратно към лобито</span>
            </a>
        </nav>
    </header>

    <main class="min-h-[calc(100vh-160px)] flex items-center justify-center py-12 px-4">
        
        <section id="login-required-container" class="w-full max-w-2xl hidden">
            <div class="p-8 text-center flex flex-col items-center gap-6" style="background: linear-gradient(145deg, #1c102f, #10081c); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                <i class="fas fa-lock text-7xl text-cyan-400"></i>
                <h2 class="text-4xl font-bold gradient-text" style="font-family: 'Orbitron', sans-serif;">Достъпът е ограничен</h2>
                <p class="text-gray-300 text-lg max-w-md">Трябва да сте влезли в профила си и да имате потвърден имейл, за да играете Мини.</p>
                <a href="index.html" class="mt-4 px-8 py-3 rounded-full text-xl btn-action inline-block">Към лобито / Вход</a>
            </div>
        </section>

        <div id="game-and-videos-layout" class="container mx-auto hidden">
             <div class="flex flex-row items-stretch justify-center gap-4 lg:gap-8">
                
                <div class="hidden lg:block w-1/5 video-container">
                    <video id="left-video-1" class="video-player" autoplay muted playsinline></video>
                    <video id="left-video-2" class="video-player" muted playsinline></video>
                </div>

                <section id="mines-game-container" class="w-full max-w-5xl">
                    <div class="flex flex-col md:flex-row gap-8 p-6 md:p-8 rounded-2xl" style="background: rgba(16, 8, 28, 0.7); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);">
                        
                        <div class="w-full md:w-1/3 lg:w-1/4 p-6 rounded-xl flex flex-col" style="background: rgba(16, 8, 28, 0.9); border: 1px solid rgba(255,255,255,0.1);">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-3xl font-bold" style="font-family: 'Orbitron', sans-serif;">Мини</h3>
                                <div class="text-lg font-semibold flex items-center gap-2 text-cyan-400">
                                    <i class="fas fa-coins"></i>
                                    <span id="balance-display" style="font-family: 'Orbitron', sans-serif;">0.00</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="bet-amount" class="block text-sm font-medium text-gray-400 mb-2">Залог</label>
                                <input type="number" id="bet-amount" value="10" class="form-input">
                            </div>
                            <div class="mb-6">
                                <label for="mines-count" class="block text-sm font-medium text-gray-400 mb-2">Брой мини</label>
                                <select id="mines-count" class="form-input">
                                    <option value="3">3</option><option value="5" selected>5</option><option value="7">7</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="24">24 (Екстремно)</option>
                                </select>
                            </div>
                            <div class="rounded-lg p-4 mb-6 space-y-4 text-center" style="background: rgba(0,0,0,0.3);">
                                <div>
                                    <p class="text-sm text-gray-400 uppercase tracking-wider">Следващ Множител</p>
                                    <p id="next-multiplier-display" class="text-2xl font-bold text-cyan-400" style="font-family: 'Orbitron', sans-serif;">1.24x</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400 uppercase tracking-wider">Обща Печалба</p>
                                    <p id="profit-display" class="text-2xl font-bold" style="color: #27ae60; font-family: 'Orbitron', sans-serif;">0.00</p>
                                </div>
                            </div>
                            <button id="play-btn" class="w-full py-4 text-xl btn-action mt-auto">Играй</button>
                        </div>

                        <div class="w-full md:w-2/3 lg:w-3/4 flex items-center justify-center relative">
                            <div id="mines-grid" class="grid grid-cols-5 gap-2 md:gap-3 w-full max-w-lg"></div>
                        </div>
                    </div>
                </section>

                <div class="hidden lg:block w-1/5 video-container">
                    <video id="right-video-1" class="video-player" autoplay muted playsinline></video>
                    <video id="right-video-2" class="video-player" muted playsinline></video>
                </div>
             </div>
        </div>
    </main>

    <footer class="bg-black/30 text-gray-400 py-6">
        <div class="container mx-auto px-6 text-center">
            <p class="text-xs text-gray-500">Играта е предназначена само за забавление за лица над 18 години. Използват се виртуални кредити без реална стойност.</p>
            <p class="text-sm mt-2">&copy; 2024 NIVRA. Всички права запазени.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.appspot.com",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e736e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const gameLayout = document.getElementById('game-and-videos-layout');
        const loginRequiredContainer = document.getElementById('login-required-container');
        let unsubscribeUserListener;

        // --- ЛОГИКА ЗА ВИДЕАТА С ИЗРИЧНО ИЗБРОЕНИ ФАЙЛОВЕ ---
        function initializeVideoPlayers() {
            // КОНКРЕТЕН СПИСЪК С ВИДЕО ФАЙЛОВЕ, КАКТО ПОИСКА
            const videoFiles = [
                "kote1_v1.webm",
                "kote2_v1.webm",
                "kote3_v1.webm",
                "kote4_v1.webm",
                "kote5_v1.webm",
                "kote6_v1.webm",
                "kote7_v1.webm",
                "kote8_v1.webm"
            ];

            function setupSeamlessLoop(video1, video2) {
                video1.style.opacity = 0;
                video2.style.opacity = 0;

                let activeVideo = video1;
                let nextVideo = video2;

                const getRandomVideoSrc = () => videoFiles[Math.floor(Math.random() * videoFiles.length)];

                activeVideo.src = getRandomVideoSrc();
                nextVideo.src = getRandomVideoSrc();

                activeVideo.addEventListener('canplay', () => {
                    activeVideo.style.opacity = 1;
                }, { once: true });

                const handleTimeUpdate = () => {
                    if (activeVideo.duration && activeVideo.currentTime > activeVideo.duration - 0.5) {
                        nextVideo.play().catch(e => console.error("Video play error:", e));
                        activeVideo.style.opacity = 0;
                        nextVideo.style.opacity = 1;
                        
                        const oldActive = activeVideo;
                        activeVideo = nextVideo;
                        nextVideo = oldActive;
                        
                        nextVideo.currentTime = 0;
                        nextVideo.src = getRandomVideoSrc();
                    }
                };
                
                video1.addEventListener('timeupdate', handleTimeUpdate);
                video2.addEventListener('timeupdate', handleTimeUpdate);
            }

            setupSeamlessLoop(
                document.getElementById('left-video-1'), 
                document.getElementById('left-video-2')
            );
            setupSeamlessLoop(
                document.getElementById('right-video-1'),
                document.getElementById('right-video-2')
            );
        }
        
        initializeVideoPlayers();

        onAuthStateChanged(auth, (user) => {
            if (unsubscribeUserListener) unsubscribeUserListener(); 
            if (user && user.emailVerified) {
                gameLayout.classList.remove('hidden');
                loginRequiredContainer.classList.add('hidden');
                const userDocRef = doc(db, 'users', user.uid);
                initializeMinesGame(userDocRef);
            } else {
                gameLayout.classList.add('hidden');
                loginRequiredContainer.classList.remove('hidden');
            }
        });
        
        // --- ЛОГИКАТА НА ИГРАТА (БЕЗ ПРОМЯНА) ---
        function initializeMinesGame(userDocRef) {
            const minesGrid = document.getElementById('mines-grid');
            const playBtn = document.getElementById('play-btn');
            const betAmountInput = document.getElementById('bet-amount');
            const minesCountSelect = document.getElementById('mines-count');
            const balanceDisplay = document.getElementById('balance-display');
            const profitDisplay = document.getElementById('profit-display');
            const nextMultiplierDisplay = document.getElementById('next-multiplier-display');
            
            const TILE_COUNT = 25;
            let currentBalance = 0;
            let isGameActive = false;
            let currentBet = 0;
            let mineLocations = [];
            let openedTilesCount = 0;

            unsubscribeUserListener = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBalance = docSnap.data().chips;
                    balanceDisplay.textContent = currentBalance.toFixed(2);
                } else {
                    console.error("User document not found!");
                }
            });

            async function updateBalanceInFirestore(newBalance) {
                if (!userDocRef) return;
                try {
                    await updateDoc(userDocRef, { chips: newBalance });
                } catch (error) {
                    console.error("Error updating balance:", error);
                }
            }

            function initGame() {
                minesGrid.innerHTML = '';
                for (let i = 0; i < TILE_COUNT; i++) {
                    const tile = document.createElement('button');
                    tile.classList.add('mines-tile', 'rounded-md', 'flex', 'items-center', 'justify-center');
                    tile.dataset.index = i;
                    tile.disabled = true;
                    minesGrid.appendChild(tile);
                    tile.addEventListener('click', () => handleTileClick(i));
                }
                playBtn.addEventListener('click', toggleGameState);
                minesCountSelect.addEventListener('change', updateNextMultiplierDisplay);
                updateNextMultiplierDisplay();
            }

            function toggleGameState() {
                if (isGameActive) { cashOut(); } else { startGame(); }
            }
            
            async function startGame() {
                const bet = parseFloat(betAmountInput.value);
                if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                    flashInputBorder(betAmountInput);
                    return;
                }
                
                resetBoard(true);
                currentBet = bet;
                
                await updateBalanceInFirestore(currentBalance - currentBet);

                isGameActive = true;
                openedTilesCount = 0;
                profitDisplay.textContent = '0.00';
                
                mineLocations = [];
                const allIndices = Array.from(Array(TILE_COUNT).keys());
                const minesCount = parseInt(minesCountSelect.value);
                for (let i = 0; i < minesCount; i++) {
                    const randomIndex = Math.floor(Math.random() * allIndices.length);
                    mineLocations.push(allIndices.splice(randomIndex, 1)[0]);
                }
                
                playBtn.textContent = 'Кеш аут';
                playBtn.disabled = true;
                betAmountInput.disabled = true;
                minesCountSelect.disabled = true;
                updateNextMultiplierDisplay();
            }

            function handleTileClick(index) {
                if (!isGameActive) return;
                const tile = minesGrid.children[index];
                if (tile.disabled) return;

                if (mineLocations.includes(index)) {
                    endGame(false);
                } else {
                    playBtn.disabled = false;
                    tile.innerHTML = '<i class="fas fa-gem"></i>';
                    tile.classList.add('safe');
                    tile.disabled = true;
                    openedTilesCount++;

                    const currentProfit = currentBet * calculateMultiplier() - currentBet;
                    profitDisplay.textContent = currentProfit.toFixed(2);
                    
                    const totalCashout = currentBet + currentProfit;
                    playBtn.innerHTML = `Кеш аут <span class="text-sm block font-normal">${totalCashout.toFixed(2)}</span>`;
                    updateNextMultiplierDisplay();

                    const safeTilesCount = TILE_COUNT - parseInt(minesCountSelect.value);
                    if (openedTilesCount === safeTilesCount) { cashOut(); }
                }
            }
            
            async function cashOut() {
                if (!isGameActive || openedTilesCount === 0) return;
                const winnings = currentBet * calculateMultiplier();
                await updateBalanceInFirestore(currentBalance + winnings); 
                endGame(true);
            }

            function endGame(isWin) {
                isGameActive = false;
                
                for (let i = 0; i < TILE_COUNT; i++) {
                    const tile = minesGrid.children[i];
                    tile.disabled = true;
                    if (mineLocations.includes(i)) {
                        tile.innerHTML = '<i class="fas fa-bomb"></i>'; tile.classList.add('mine');
                    } else if (!tile.classList.contains('safe')) {
                        if (!isWin) {
                           tile.innerHTML = '<i class="fas fa-gem text-gray-600"></i>';
                        }
                    }
                }
                
                playBtn.innerHTML = 'Играй';
                playBtn.disabled = false;
                betAmountInput.disabled = false;
                minesCountSelect.disabled = false;
                profitDisplay.textContent = '0.00';
                updateNextMultiplierDisplay();
            }
            
            function resetBoard(enableTiles) {
                for (const tile of minesGrid.children) {
                    tile.innerHTML = ''; tile.className = 'mines-tile rounded-md flex items-center justify-center'; tile.disabled = !enableTiles;
                }
            }
            
            function calculateMultiplier(tilesToOpen = openedTilesCount) {
                if (tilesToOpen === 0) return 1;
                const minesCount = parseInt(minesCountSelect.value);
                const safeTilesCount = TILE_COUNT - minesCount;
                if (tilesToOpen > safeTilesCount) return 0;
                
                function combinations(n, k) {
                    if (k < 0 || k > n) return 0; if (k === 0 || k === n) return 1; if (k > n / 2) k = n - k; let res = 1;
                    for (let i = 1; i <= k; i++) { res = res * (n - i + 1) / i; } return res;
                }
                
                const totalCombinations = combinations(TILE_COUNT, tilesToOpen);
                const safeCombinations = combinations(safeTilesCount, tilesToOpen);
                return 0.99 * (totalCombinations / safeCombinations);
            }

            function updateNextMultiplierDisplay() {
                if (isGameActive) {
                    const nextTilesOpened = openedTilesCount + 1;
                    const nextMultiplier = calculateMultiplier(nextTilesOpened);
                    nextMultiplierDisplay.textContent = nextMultiplier > 0 ? `${nextMultiplier.toFixed(2)}x` : 'MAX';
                } else {
                    const nextMultiplier = calculateMultiplier(1);
                    nextMultiplierDisplay.textContent = `${nextMultiplier.toFixed(2)}x`;
                }
            }
            
            function flashInputBorder(inputElement) {
                inputElement.style.borderColor = 'var(--neon-pink)';
                inputElement.style.boxShadow = '0 0 10px var(--neon-pink)';
                setTimeout(() => { 
                    inputElement.style.borderColor = '';
                    inputElement.style.boxShadow = '';
                }, 1500);
            }

            initGame();
        }
    </script>
</body>
</html>
