<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVRA - Мини</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Custom styles for the game */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .gradient-text {
            background: linear-gradient(90deg, #f7b733, #fc4a1a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background: linear-gradient(90deg, #f7b733, #fc4a1a);
            transition: all 0.2s ease-out;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(247, 183, 51, 0.2);
        }
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: none;
        }
        .btn-primary:disabled {
            background: #4a4a6a;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* Styles for Mines Game */
        .mines-tile {
            background-color: #2c2c44;
            transition: all 0.15s ease;
            aspect-ratio: 1 / 1;
        }
        .mines-tile:not(:disabled):hover {
            background-color: #3a3a5a;
            transform: scale(1.05);
        }
        .mines-tile.safe {
            background-color: #27ae60;
            color: white;
            transform: scale(1.05);
            font-size: 1.5rem;
        }
        .mines-tile.mine {
            background-color: #c0392b;
            color: white;
            transform: scale(1.05);
            font-size: 1.5rem;
        }
        .mines-tile:disabled {
            cursor: not-allowed;
            opacity: 0.9;
        }
        input[type="number"] {
             -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Simple Header -->
    <header class="bg-gray-900 shadow-lg">
        <nav class="container mx-auto px-6 py-4 flex justify-center md:justify-start">
            <!-- START OF CHANGE -->
            <a href="nivracasino.html" class="text-2xl font-bold text-gray-300 hover:text-yellow-400 transition">
                <i class="fas fa-arrow-left mr-2"></i> Обратно към лобито
            </a>
            <!-- END OF CHANGE -->
        </nav>
    </header>

    <main class="min-h-[calc(100vh-160px)] flex items-center justify-center py-12 px-4">
        <!-- Mines Game Section - Hidden by default -->
        <section id="mines-game-container" class="w-full max-w-5xl hidden">
            <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 md:p-8 flex flex-col md:flex-row gap-8">
                
                <!-- Left Panel - Controls -->
                <div class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-6 rounded-xl flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">Мини</h3>
                        <div class="text-lg font-semibold">
                            <i class="fas fa-wallet text-yellow-400"></i>
                            <span id="balance-display">0.00</span>
                        </div>
                    </div>

                    <!-- Bet Amount -->
                    <div class="mb-4">
                        <label for="bet-amount" class="block text-sm font-medium text-gray-400 mb-1">Залог</label>
                        <input type="number" id="bet-amount" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all">
                    </div>

                    <!-- Number of Mines -->
                    <div class="mb-6">
                         <label for="mines-count" class="block text-sm font-medium text-gray-400 mb-1">Брой мини</label>
                        <select id="mines-count" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="3">3</option>
                            <option value="5" selected>5</option>
                            <option value="7">7</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="24">24 (Екстремно)</option>
                        </select>
                    </div>
                    
                    <!-- Game Info -->
                    <div class="bg-gray-700 rounded-lg p-4 mb-6 space-y-3 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Следващ Множител</p>
                            <p id="next-multiplier-display" class="text-2xl font-bold text-yellow-400">1.24x</p>
                        </div>
                         <div>
                            <p class="text-sm text-gray-400">Обща Печалба</p>
                            <p id="profit-display" class="text-2xl font-bold text-green-400">0.00</p>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="play-btn" class="w-full py-4 rounded-lg text-black font-bold text-xl btn-primary mt-auto">
                        Играй
                    </button>
                </div>

                <!-- Right Panel - Game Board -->
                <div class="w-full md:w-2/3 lg:w-3/4 flex items-center justify-center relative">
                    <div id="mines-grid" class="grid grid-cols-5 gap-2 md:gap-3 w-full max-w-lg">
                        <!-- Tiles will be generated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Login Required Message - Hidden by default -->
        <section id="login-required-container" class="w-full max-w-2xl hidden">
            <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 text-center flex flex-col items-center gap-6">
                <i class="fas fa-lock text-7xl text-yellow-400"></i>
                <h2 class="text-4xl font-bold gradient-text">Достъпът е ограничен</h2>
                <p class="text-gray-300 text-lg max-w-md">
                    Трябва да сте влезли в профила си и да имате потвърден имейл, за да играете Мини.
                </p>
                <a href="nivracasino.html" class="mt-4 px-8 py-4 rounded-lg text-black font-bold text-xl btn-primary inline-block">
                    Към лобито / Вход
                </a>
            </div>
        </section>
    </main>

    <!-- Simple Footer -->
    <footer class="bg-gray-900 text-gray-500 text-center py-6">
        <p class="text-xs">Играта е предназначена само за забавление за лица над 18 години. Използват се виртуални кредити без реална стойност.</p>
        <p class="text-sm mt-2">&copy; 2024 NIVRA. Всички права запазени.</p>
    </footer>

    <!-- START OF SCRIPT CHANGE -->
    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ВАШИЯТ FIREBASE CONFIG ОБЕКТ ---
        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.firebasestorage.app",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e736e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };

        // --- ИНИЦИАЛИЗАЦИЯ НА FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Глобални променливи ---
        let currentUser = null;
        let userDocRef = null;
        const gameContainer = document.getElementById('mines-game-container');
        const loginRequiredContainer = document.getElementById('login-required-container');

        // --- Функция за обновяване на баланса в Firestore ---
        async function updateBalanceInFirestore(newBalance) {
            if (!userDocRef) return;
            try {
                await updateDoc(userDocRef, { chips: newBalance });
            } catch (error) {
                console.error("Грешка при обновяване на баланса:", error);
            }
        }
        
        // --- Проверка на състоянието на аутентикация ---
        let isGameInitialized = false;
        let updateExternalBalanceChange = null;

        onAuthStateChanged(auth, async (user) => {
            if (user && user.emailVerified) {
                gameContainer.classList.remove('hidden');
                loginRequiredContainer.classList.add('hidden');
                
                currentUser = user;
                userDocRef = doc(db, 'users', user.uid);

                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const newBalance = docSnap.data().chips;
                        
                        if (!isGameInitialized) {
                            updateExternalBalanceChange = initializeMinesGame(newBalance);
                            isGameInitialized = true;
                        } else if (updateExternalBalanceChange) {
                            updateExternalBalanceChange(newBalance);
                        }
                    } else {
                        console.error("Не е намерен документ за потребителя!");
                        loginRequiredContainer.querySelector('p').textContent = "Възникна грешка с профила ви.";
                        gameContainer.classList.add('hidden');
                        loginRequiredContainer.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("Грешка при зареждане на потребителски данни:", error);
                    loginRequiredContainer.querySelector('p').textContent = "Не можахме да заредим данните ви.";
                    gameContainer.classList.add('hidden');
                    loginRequiredContainer.classList.remove('hidden');
                });
            } else {
                gameContainer.classList.add('hidden');
                loginRequiredContainer.classList.remove('hidden');
            }
        });


        // --- Логиката на играта, обвита във функция ---
        function initializeMinesGame(initialBalance) {
            // ======================= MINES GAME LOGIC =======================
            const minesGrid = document.getElementById('mines-grid');
            const playBtn = document.getElementById('play-btn');
            const betAmountInput = document.getElementById('bet-amount');
            const minesCountSelect = document.getElementById('mines-count');
            const balanceDisplay = document.getElementById('balance-display');
            const profitDisplay = document.getElementById('profit-display');
            const nextMultiplierDisplay = document.getElementById('next-multiplier-display');
            
            const TILE_COUNT = 25;
            let balance = initialBalance; // ПРОМЯНА: Използваме подадения баланс
            let isGameActive = false;
            let currentBet = 0;
            let mineLocations = [];
            let openedTilesCount = 0;

            function initGame() {
                minesGrid.innerHTML = '';
                for (let i = 0; i < TILE_COUNT; i++) {
                    const tile = document.createElement('button');
                    tile.classList.add('mines-tile', 'rounded-md', 'flex', 'items-center', 'justify-center');
                    tile.dataset.index = i;
                    tile.disabled = true;
                    minesGrid.appendChild(tile);
                    tile.addEventListener('click', () => handleTileClick(i));
                }
                playBtn.addEventListener('click', toggleGameState);
                minesCountSelect.addEventListener('change', updateNextMultiplierDisplay);
                updateBalanceDisplay(); // ПРОМЯНА: Показваме началния баланс
                updateNextMultiplierDisplay();
            }

            function toggleGameState() {
                if (isGameActive) {
                    cashOut();
                } else {
                    startGame();
                }
            }
            
            function startGame() {
                const bet = parseFloat(betAmountInput.value);
                if (isNaN(bet) || bet <= 0 || bet > balance) {
                    flashInputBorder(betAmountInput);
                    return;
                }
                
                resetBoard(true);
                
                currentBet = bet;
                balance -= currentBet;
                updateBalanceDisplay();
                updateBalanceInFirestore(balance); // ПРОМЯНА: Обновяваме в DB

                isGameActive = true;
                openedTilesCount = 0;
                profitDisplay.textContent = '0.00';
                
                mineLocations = [];
                const allIndices = Array.from(Array(TILE_COUNT).keys());
                const minesCount = parseInt(minesCountSelect.value);
                for (let i = 0; i < minesCount; i++) {
                    const randomIndex = Math.floor(Math.random() * allIndices.length);
                    mineLocations.push(allIndices.splice(randomIndex, 1)[0]);
                }
                
                playBtn.textContent = 'Кеш аут';
                playBtn.disabled = true;
                betAmountInput.disabled = true;
                minesCountSelect.disabled = true;
                updateNextMultiplierDisplay();
            }

            function handleTileClick(index) {
                if (!isGameActive) return;
                
                const tile = minesGrid.children[index];
                if (tile.disabled) return;

                if (mineLocations.includes(index)) {
                    endGame(false);
                } else {
                    playBtn.disabled = false;
                    tile.innerHTML = '<i class="fas fa-gem"></i>';
                    tile.classList.add('safe');
                    tile.disabled = true;
                    openedTilesCount++;

                    const currentProfit = currentBet * calculateMultiplier() - currentBet;
                    profitDisplay.textContent = currentProfit.toFixed(2);
                    
                    playBtn.innerHTML = `Кеш аут <span class="text-sm block font-normal">${(currentBet + currentProfit).toFixed(2)}</span>`;
                    updateNextMultiplierDisplay();

                    const safeTilesCount = TILE_COUNT - parseInt(minesCountSelect.value);
                    if (openedTilesCount === safeTilesCount) {
                        cashOut();
                    }
                }
            }
            
            function cashOut() {
                if (!isGameActive || openedTilesCount === 0) return;
                const winnings = currentBet * calculateMultiplier();
                balance += winnings;
                updateBalanceInFirestore(balance); // ПРОМЯНА: Обновяваме в DB
                endGame(true);
            }

            function endGame(isWin) {
                isGameActive = false;
                
                for (let i = 0; i < TILE_COUNT; i++) {
                    const tile = minesGrid.children[i];
                    tile.disabled = true;
                    if (mineLocations.includes(i)) {
                        tile.innerHTML = '<i class="fas fa-bomb"></i>';
                        tile.classList.add('mine');
                    } else if (!tile.classList.contains('safe')) {
                        tile.innerHTML = '<i class="fas fa-gem text-gray-600"></i>';
                    }
                }
                
                playBtn.innerHTML = 'Играй';
                playBtn.disabled = false;
                betAmountInput.disabled = false;
                minesCountSelect.disabled = false;
                profitDisplay.textContent = '0.00';
                updateBalanceDisplay();
                updateNextMultiplierDisplay();
            }
            
            function resetBoard(enableTiles) {
                for (const tile of minesGrid.children) {
                    tile.innerHTML = '';
                    tile.className = 'mines-tile rounded-md flex items-center justify-center';
                    tile.disabled = !enableTiles;
                }
            }

            function updateBalanceDisplay() {
                balanceDisplay.textContent = balance.toFixed(2);
            }
            
            function calculateMultiplier(tilesToOpen = openedTilesCount) {
                if (tilesToOpen === 0) return 1;
                const minesCount = parseInt(minesCountSelect.value);
                const safeTilesCount = TILE_COUNT - minesCount;
                if (tilesToOpen > safeTilesCount) return 0;
                
                function combinations(n, k) {
                    if (k < 0 || k > n) return 0;
                    if (k === 0 || k === n) return 1;
                    if (k > n / 2) k = n - k;
                    let res = 1;
                    for (let i = 1; i <= k; i++) {
                        res = res * (n - i + 1) / i;
                    }
                    return res;
                }
                
                const totalCombinations = combinations(TILE_COUNT, tilesToOpen);
                const safeCombinations = combinations(safeTilesCount, tilesToOpen);
                const multiplier = 0.99 * (totalCombinations / safeCombinations);
                return multiplier;
            }

            function updateNextMultiplierDisplay() {
                const nextTilesOpened = isGameActive ? openedTilesCount + 1 : 1;
                const nextMultiplier = calculateMultiplier(nextTilesOpened);
                if (nextMultiplier > 0) {
                     nextMultiplierDisplay.textContent = `${nextMultiplier.toFixed(2)}x`;
                } else {
                     nextMultiplierDisplay.textContent = 'MAX';
                }
            }
            
            function flashInputBorder(inputElement) {
                inputElement.classList.add('border-red-500', 'ring-red-500');
                setTimeout(() => {
                     inputElement.classList.remove('border-red-500', 'ring-red-500');
                }, 1000);
            }

            initGame();

            // ПРОМЯНА: Връщаме функция за външно обновяване на баланса
            return function(newBalance) {
                if (!isGameActive) {
                    balance = newBalance;
                    updateBalanceDisplay();
                } else {
                    console.log("Балансът е променен външно, но ще се синхронизира след края на рунда.");
                }
            };
        }
    </script>
    <!-- END OF SCRIPT CHANGE -->
</body>
</html>