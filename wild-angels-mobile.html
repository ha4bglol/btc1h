<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Wild Angels - Vertical Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --glow-color: #00ffc3;
            --secondary-glow: #f900ff;
            --win-glow-color: #ffee00;
            --anticipation-glow-color: #ffc400;
            --scatter-glow-color: #f900ff;
            --font-main: 'Poppins', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --symbol-size-vh: 14vh;
            --symbol-size: clamp(60px, var(--symbol-size-vh), 110px);
            --reels-height: calc(var(--symbol-size) * 3);
            --reels-width: calc(var(--symbol-size) * 5);
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: var(--font-main);
            color: #fff;
            background-color: #100a1c;
        }

        body {
            background: linear-gradient(135deg, #f900ff, #00ffc3, #2e005e, #100a1c);
            background-size: 400% 400%;
            animation: color-shift 15s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @keyframes color-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- Екрани за зареждане и логин (без промяна) --- */
        #loading-screen, #login-required-container, .modal {
            position: fixed; inset: 0; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #100a1c;
        }
        .loading-title { font-family: var(--font-title); font-size: clamp(3rem, 10vmin, 6rem); background: linear-gradient(90deg, var(--secondary-glow), var(--glow-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .progress-bar-container { width: 80%; max-width: 500px; height: 20px; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 2px solid var(--glow-color); }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary-glow), var(--glow-color)); transition: width 0.3s ease-out; }
        #loading-percentage { font-family: var(--font-title); font-size: 1.5rem; margin-top: 1rem; }
        #login-required-container { display: none; }
        .login-box { background: rgba(0,0,0,0.4); border: 2px solid var(--glow-color); border-radius: 2vmin; padding: 3rem; text-align: center; }
        .login-box a { display: inline-block; margin-top: 2rem; padding: 1rem 2rem; font-family: var(--font-title); background: var(--glow-color); color: #100a1c; text-decoration: none; font-weight: bold; transition: all 0.2s; }

        /* --- Основен контейнер на играта --- */
        #game-wrapper {
            width: 100%;
            height: 100%;
            max-width: 500px; /* Максимална ширина за по-добър изглед */
            max-height: 950px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            padding: 10px;
        }

        .game-container {
            width: 100%;
            aspect-ratio: 9 / 16; /* Запазва пропорциите на телефона */
            min-height: 0; /* Нужно за flexbox в Firefox */
            background: rgba(17, 29, 39, 0.5);
            backdrop-filter: blur(5px);
            display: none; /* Показва се от JS след зареждане */
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border-radius: 15px;
            border: 2px solid var(--glow-color);
            box-shadow: 0 0 25px rgba(0, 255, 195, 0.5);
        }
        
        #mute-button {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.4); border: 1px solid var(--glow-color); color: var(--glow-color);
            border-radius: 50%; cursor: pointer; z-index: 1100; font-size: 1.2rem;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s;
        }

        .game-header { text-align: center; padding: 10px 0; }
        #header-image { height: 5vh; max-height: 40px; filter: drop-shadow(0 0 10px #000); }
        .game-header h1 {
            font-family: var(--font-title); font-size: clamp(1.5rem, 7vw, 2rem); margin: 0;
            animation: rgb-text-glow 5s linear infinite;
        }
        @keyframes rgb-text-glow {
            0%, 100% { color: var(--glow-color); text-shadow: 0 0 8px var(--glow-color); }
            50% { color: var(--secondary-glow); text-shadow: 0 0 8px var(--secondary-glow); }
        }
        
        /* --- Стил на барабаните --- */
        .slot-machine-wrapper {
            position: relative;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            height: var(--reels-height);
        }
        .slot-machine {
            display: flex;
            gap: 10px;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--glow-color);
            border-radius: 10px;
            box-shadow: 0 0 15px var(--glow-color), inset 0 0 10px rgba(0, 255, 195, 0.5);
        }
        .reel {
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, rgba(249, 0, 255, 0.1), rgba(0, 255, 195, 0.1));
            border-radius: 5px;
            box-shadow: inset 0 0 10px #000;
        }
        .reel-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        .symbol {
            width: 100%;
            height: var(--symbol-size);
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .symbol img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.7));
            transition: transform 0.3s, filter 0.3s;
        }
        
        /* НОВА АНИМАЦИЯ ЗА РАЗМАЗВАНЕ ПРИ ВЪРТЕНЕ */
        .reel.spinning .reel-strip {
            filter: blur(4px);
        }

        /* --- Win Lines и Анимации на символи (без промяна) --- */
        #win-lines-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        #win-lines-svg { overflow: visible; width: 100%; height: 100%; }
        .win-line { fill: none; stroke: var(--secondary-glow); stroke-width: 5px; filter: drop-shadow(0 0 5px var(--secondary-glow)) drop-shadow(0 0 15px var(--secondary-glow)); stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw-line 0.8s ease-out forwards, blink-line 1s linear infinite 0.8s; }
        @keyframes draw-line { to { stroke-dashoffset: 0; } }
        @keyframes blink-line { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .symbol.win-pulse img { animation: win-pulse-anim 1s ease-out infinite; }
        @keyframes win-pulse-anim { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px var(--win-glow-color)) brightness(1.2); } 50% { transform: scale(1.25); filter: drop-shadow(0 0 25px var(--win-glow-color)) drop-shadow(0 0 10px #fff) brightness(1.8); } }
        .symbol.scatter-trigger img { animation: scatter-trigger-anim 1.5s ease-in-out infinite; }
        @keyframes scatter-trigger-anim { 0%, 100% { transform: scale(1.1) translateY(-5%); filter: drop-shadow(0 0 15px var(--scatter-glow-color)) drop-shadow(0 0 25px var(--scatter-glow-color)) brightness(1.5); } 50% { transform: scale(1.3) translateY(-10%); filter: drop-shadow(0 0 30px var(--scatter-glow-color)) drop-shadow(0 0 50px #fff) brightness(2.0); } }
        .slot-machine.anticipation-glow { animation: anticipation-pulse 1.2s infinite; }
        @keyframes anticipation-pulse { 0%, 100% { box-shadow: 0 0 3vmin var(--glow-color), inset 0 0 2vmin rgba(0, 255, 195, 0.5); } 50% { box-shadow: 0 0 8vmin var(--anticipation-glow-color), inset 0 0 4vmin var(--anticipation-glow-color); } }

        /* --- НОВ КОНТРОЛЕН ПАНЕЛ --- */
        #game-footer {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #message-box {
            font-family: var(--font-title);
            font-size: clamp(1rem, 4.5vw, 1.4rem);
            color: var(--win-glow-color);
            text-shadow: 0 0 10px var(--win-glow-color);
            font-weight: bold;
            text-align: center;
            height: 3vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glow-color);
            border-radius: 8px;
            padding: 8px;
        }
        .info-box {
            text-align: center;
        }
        .info-box .label {
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            color: #ccc;
            text-transform: uppercase;
        }
        .info-box .value {
            font-family: var(--font-title);
            display: block;
            font-size: clamp(1rem, 4vw, 1.2rem);
            color: var(--glow-color);
            letter-spacing: 1px;
        }
        
        #bet-selection-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
        }
        .bet-spin-btn {
            font-family: var(--font-title);
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(0, 255, 195, 0.5);
            color: #fff;
            padding: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: clamp(0.8rem, 3.5vw, 1rem);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
         .bet-spin-btn:hover:not(:disabled) {
            border-color: var(--glow-color);
            background: rgba(0, 255, 195, 0.2);
            transform: translateY(-2px);
        }
        .bet-spin-btn:disabled {
            filter: grayscale(1) brightness(0.6);
            cursor: not-allowed;
        }
        
        .secondary-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .control-btn {
            font-family: var(--font-title);
            font-size: clamp(0.7rem, 2.8vw, 0.8rem);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            color: #fff;
            background: linear-gradient(45deg, #d81b60, #f900ff);
            box-shadow: 0 0 10px var(--secondary-glow);
            border: 1px solid var(--secondary-glow);
        }
        #autoSpinButton.active {
             background: var(--secondary-glow);
        }

        /* --- Модали (без промяна) --- */
        .modal { display: none; }
        .modal-content { font-family: 'Orbitron', sans-serif; animation: modal-appear 1s forwards; background: rgba(10, 0, 20, 0.95); border: 2px solid var(--glow-color); border-radius: 2vmin; padding: 3vmin; max-width: 90vw; max-height: 90vh; box-shadow: 0 0 50px var(--secondary-glow); }
        @keyframes modal-appear { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .modal-title { font-size: 5vmin; color: var(--glow-color); }
        #bonus-transition-screen { cursor: pointer; z-index: 2000; flex-direction: column; }
        .bonus-transition-content h1 { font-size: clamp(3rem, 10vmin, 8rem); color: var(--win-glow-color); text-shadow: 0 0 10px var(--win-glow-color), 0 0 30px var(--win-glow-color); }
    </style>
</head>
<body>
    <div id="loading-screen">
        <h1 class="loading-title">NIVRA</h1>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p id="loading-percentage">0%</p>
    </div>

    <div id="login-required-container">
        <div class="login-box">
            <i class="fas fa-lock"></i>
            <h2>Достъпът е ограничен</h2>
            <p>Трябва да сте влезли в профила си, за да играете.</p>
            <a href="index.html">Към лобито / Вход</a>
        </div>
    </div>
    
    <div id="game-wrapper">
        <div class="game-container">
            <button id="mute-button"><i class="fas fa-volume-high"></i></button>

            <header class="game-header">
                <img id="header-image" src="" alt="Header Symbol">
                <h1>WILD ANGELS</h1>
            </header>

            <main class="slot-machine-wrapper">
                <div class="slot-machine">
                    <div class="reel" id="reel0"><div class="reel-strip"></div></div>
                    <div class="reel" id="reel1"><div class="reel-strip"></div></div>
                    <div class="reel" id="reel2"><div class="reel-strip"></div></div>
                    <div class="reel" id="reel3"><div class="reel-strip"></div></div>
                    <div class="reel" id="reel4"><div class="reel-strip"></div></div>
                </div>
                 <div id="win-lines-container">
                    <svg id="win-lines-svg"></svg>
                </div>
            </main>

            <footer id="game-footer">
                <div id="message-box">ИЗБЕРЕТЕ ЗАЛОГ</div>
                <div class="info-bar">
                    <div class="info-box">
                        <span class="label">Баланс:</span>
                        <span id="balance-value" class="value">0.00</span>
                    </div>
                    <div class="info-box">
                        <span class="label">Печалба:</span>
                        <span id="win-value" class="value">0.00</span>
                    </div>
                </div>
                <div id="bet-selection-bar">
                    <!-- Бутоните за залог се генерират от JS -->
                </div>
                <div class="secondary-controls">
                     <button id="buyBonusButton" class="control-btn">КУПИ БОНУС</button>
                     <button id="autoSpinButton" class="control-btn">AUTO</button>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Модалите остават същите -->
    <div class="modal" id="bonus-modal">
        <div class="modal-content">
            <h2 id="modal-title" class="modal-title">БОНУС ИГРА!</h2>
            <p id="modal-subtitle" class="modal-subtitle"></p>
            <div id="expanding-symbol-info">
                <h3>Специален Символ:</h3>
                <img id="expanding-symbol-display" src="" alt="Expanding Symbol">
            </div>
        </div>
    </div>
    <div class="modal" id="bonus-transition-screen">
        <div class="bonus-transition-content">
            <h1>БОНУС ИГРА!</h1>
            <p>НАТИСНЕТЕ, ЗА ДА ПРОДЪЛЖИТЕ</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE КОНФИГУРАЦИЯ И ЛОГИКА (без промяна) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAatMUa6vFu2AAe3NCWse6j2moiXmXdl0U",
          authDomain: "nivra-casino.firebaseapp.com",
          projectId: "nivra-casino",
          storageBucket: "nivra-casino.firebasestorage.app",
          messagingSenderId: "463242246264",
          appId: "1:463242246264:web:4a6e736e5c8df3109e158d",
          measurementId: "G-2NF3P6H9GM"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userDocRef = null;
        let isGameInitialized = false;
        let updateExternalBalanceChange = null;
        const gameContainer = document.querySelector('.game-container');
        const loginRequiredContainer = document.getElementById('login-required-container');
        const loadingScreen = document.getElementById('loading-screen');
        const progressBar = document.getElementById('progress-bar');
        const loadingPercentage = document.getElementById('loading-percentage');

        async function updateBalanceInFirestore(newBalance) {
            if (!userDocRef) return;
            try {
                await updateDoc(userDocRef, { chips: Math.round(newBalance) });
            } catch (error) {
                console.error("Грешка при обновяване на баланса:", error);
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user && user.emailVerified) {
                userDocRef = doc(db, 'users', user.uid);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const newBalance = docSnap.data().chips;
                        if (!isGameInitialized) {
                            preloadAssetsAndStartGame(newBalance);
                            isGameInitialized = true;
                        } else if (updateExternalBalanceChange) {
                            updateExternalBalanceChange(newBalance);
                        }
                    } else { showLoginRequired("Не е намерен документ за потребителя!"); }
                }, (error) => { showLoginRequired("Грешка при зареждане на потребителски данни."); });
            } else { showLoginRequired(); }
        });
        
        function showLoginRequired(message = "Трябва да сте влезли в профила си, за да играете.") {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                loginRequiredContainer.querySelector('p').textContent = message;
                loginRequiredContainer.style.display = 'flex';
                gameContainer.style.display = 'none';
            }, 500);
        }
        
        async function preloadAssetsAndStartGame(initialBalance) {
            const SYMBOLS = {
                'angel1': { weight: 20, src: 'angel1.png', payout: { '3': 5,  '4': 10,  '5': 20  }},
                'angel2': { weight: 18, src: 'angel2.png', payout: { '3': 10, '4': 20,  '5': 40  }},
                'angel3': { weight: 15, src: 'angel3.png', payout: { '3': 15, '4': 30,  '5': 60  }},
                'angel4': { weight: 12, src: 'angel4.png', payout: { '3': 20, '4': 40,  '5': 80  }},
                'angel5': { weight: 10, src: 'angel5.png', payout: { '3': 30, '4': 60,  '5': 120 }},
                'angel6': { weight: 8,  src: 'angel6.png', payout: { '3': 50, '4': 100, '5': 200 }},
                'angel7': { weight: 6,  src: 'angel7.png', payout: { '3': 100,'4': 200, '5': 400 }},
                'angel8': { weight: 4,  src: 'angel8.png', payout: { '3': 200,'4': 400, '5': 800 }},
                'angel9': { weight: 3,  src: 'angel9.png', payout: { '3': 220,'4': 450, '5': 900 }},
                'wild':   { weight: 2,  src: 'wild.png',   isWild: true, payout: { '3': 250, '4': 500, '5': 1000 }},
                'scatter':{ weight: 5,  src: 'scatter.png',spins: 10, isScatter: true }
            };
            const SOUND_FILES = ['win_sound.mp3', 'anticipation.mp3', 'expand.mp3', 'bg_music_1.mp3', 'bg_music_2.mp3', 'bg_music_3.mp3'];
            const assetsToLoad = [];
            Object.values(SYMBOLS).forEach(s => assetsToLoad.push({type: 'image', src: s.src}));
            SOUND_FILES.forEach(name => assetsToLoad.push({type: 'audio', src: name}));
            let loadedCount = 0;
            const totalCount = assetsToLoad.length;
            const promises = assetsToLoad.map(asset => new Promise((resolve) => {
                const onAssetLoaded = () => {
                    loadedCount++;
                    const percentage = Math.round((loadedCount / totalCount) * 100);
                    progressBar.style.width = `${percentage}%`;
                    loadingPercentage.textContent = `${percentage}%`;
                    resolve();
                };
                const onAssetError = () => { onAssetLoaded(); };
                if (asset.type === 'image') { const i = new Image(); i.src = asset.src; i.onload = onAssetLoaded; i.onerror = onAssetError; } 
                else if (asset.type === 'audio') { const a = new Audio(); a.addEventListener('canplaythrough', onAssetLoaded, { once: true }); a.addEventListener('error', onAssetError, { once: true }); a.src = asset.src; }
            }));
            await Promise.all(promises);
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    gameContainer.style.display = 'flex';
                    updateExternalBalanceChange = initializeGameLogic(initialBalance, SYMBOLS);
                }, 500);
            }, 500);
        }

        function initializeGameLogic(initialBalance, SYMBOLS) {
            const REGULAR_SYMBOLS = Object.keys(SYMBOLS).filter(k => !SYMBOLS[k].isWild && !SYMBOLS[k].isScatter);
            const REEL_COUNT = 5;
            const SYMBOLS_PER_REEL_VISIBLE = 3;
            const PAYLINES = [ [1, 1, 1, 1, 1], [0, 0, 0, 0, 0], [2, 2, 2, 2, 2], [0, 1, 2, 1, 0], [2, 1, 0, 1, 2], [0, 0, 1, 2, 2], [2, 2, 1, 0, 0], [1, 0, 0, 0, 1], [1, 2, 2, 2, 1], [0, 1, 1, 1, 2] ];
            const BET_AMOUNTS = [1, 2, 5, 10, 20]; // Променете според нуждите
            
            let balance = initialBalance;
            let currentBet = BET_AMOUNTS[0];
            let isSpinning = false;
            let isAutoSpinning = false;
            let freeSpinsRemaining = 0;
            let expandingSymbol = null;
            let symbolSize = 0;
            let isMuted = false;

            // --- Елементи от DOM ---
            const autoSpinButton = document.getElementById('autoSpinButton');
            const buyBonusButton = document.getElementById('buyBonusButton');
            const balanceDisplay = document.getElementById('balance-value');
            const winDisplay = document.getElementById('win-value');
            const reels = Array.from({ length: REEL_COUNT }, (_, i) => document.getElementById(`reel${i}`));
            const slotMachine = document.querySelector('.slot-machine');
            const winLinesSvg = document.getElementById('win-lines-svg');
            const betSelectionBar = document.getElementById('bet-selection-bar');
            const messageBox = document.getElementById('message-box');
            const muteButton = document.getElementById('mute-button');
            const headerImage = document.getElementById('header-image');
            const reelStrips = [];

            // --- Аудио ---
            const winSound = new Audio('win_sound.mp3');
            const anticipationSound = new Audio('anticipation.mp3');
            const allSounds = [winSound, anticipationSound]; // Добавете другите звуци
            
            function createWeightedStrip() {
                const strip = [];
                for (const key in SYMBOLS) {
                    for (let i = 0; i < SYMBOLS[key].weight; i++) strip.push(key);
                }
                return strip.sort(() => Math.random() - 0.5);
            }
            
            function initializeReels() {
                 reels.forEach((reelElement) => {
                    const reelStripElement = reelElement.querySelector('.reel-strip');
                    reelStripElement.innerHTML = '';
                    const weightedStrip = createWeightedStrip();
                    reelStrips.push(weightedStrip);
                    const fragment = document.createDocumentFragment();
                    // Създаваме 3 пъти лентата, за да имаме безкраен ефект на въртене
                    for(let k = 0; k < 3; k++) {
                        weightedStrip.forEach(symbolKey => {
                            const symbolElement = document.createElement('div');
                            symbolElement.className = 'symbol';
                            const img = document.createElement('img');
                            img.src = SYMBOLS[symbolKey].src;
                            img.alt = symbolKey;
                            img.loading = 'lazy';
                            symbolElement.appendChild(img);
                            fragment.appendChild(symbolElement);
                        });
                    }
                    reelStripElement.appendChild(fragment);
                });
            }

            function setInitialReelPositions() {
                reels.forEach((reel, i) => {
                    const strip = reelStrips[i];
                    const randomIndex = Math.floor(Math.random() * strip.length);
                    const finalPosition = (randomIndex + strip.length) * symbolSize; // Започваме от второто копие
                    
                    const reelStripElement = reel.querySelector('.reel-strip');
                    reelStripElement.style.transition = 'none';
                    reelStripElement.style.transform = `translateY(-${finalPosition}px)`;
                });
            }
            
            function initializeUI() {
                betSelectionBar.innerHTML = '';
                BET_AMOUNTS.forEach((amount) => {
                    const button = document.createElement('button');
                    button.classList.add('bet-spin-btn');
                    button.textContent = amount.toFixed(2);
                    button.dataset.bet = amount;
                    betSelectionBar.appendChild(button);
                });
                
                symbolSize = document.querySelector('.symbol').offsetHeight;
                headerImage.src = SYMBOLS['angel9'].src; // Пример
                updateBalanceDisplay();
                updateWin(0);
            }
            
            // --- НОВА И ПОДОБРЕНА SPIN ЛОГИКА ---
            async function spin(betAmount) {
                if (isSpinning) return;
                
                if (freeSpinsRemaining === 0 && balance < betAmount) {
                    if(isAutoSpinning) toggleAutoSpin();
                    messageBox.textContent = "НЯМАТЕ КРЕДИТ";
                    return;
                }
                
                isSpinning = true;
                currentBet = betAmount;
                setControlsDisabled(true);
                clearAnimations();
                await updateWin(0);
                messageBox.textContent = "КЪСМЕТ!";
                
                if (freeSpinsRemaining > 0) {
                    freeSpinsRemaining--;
                    // update free spins display if any
                } else {
                    balance -= betAmount;
                    await updateBalanceInFirestore(balance);
                    updateBalanceDisplay();
                }
                
                let results = [];
                const finalIndexes = [];
                
                for (let i = 0; i < REEL_COUNT; i++) {
                    const strip = reelStrips[i];
                    const randomIndex = Math.floor(Math.random() * strip.length);
                    finalIndexes.push(randomIndex);
                    results.push([
                        strip[(randomIndex + 0) % strip.length],
                        strip[(randomIndex + 1) % strip.length],
                        strip[(randomIndex + 2) % strip.length]
                    ]);
                }
                
                const spinPromises = reels.map((reel, i) => {
                    return new Promise((resolve) => {
                        reel.classList.add('spinning');
                        const reelStripElement = reel.querySelector('.reel-strip');
                        const strip = reelStrips[i];
                        
                        // Позицията трябва да е във второто копие на лентата, за да има място за "отскачане"
                        const targetPosition = (finalIndexes[i] + strip.length) * symbolSize;

                        reelStripElement.style.transition = 'none';
                        const currentTransform = new DOMMatrix(getComputedStyle(reelStripElement).transform);
                        
                        // Ако сме към края на лентата, я връщаме в началото без анимация
                        if (currentTransform.f < -2 * strip.length * symbolSize) {
                             const resetPosition = currentTransform.f + strip.length * symbolSize;
                             reelStripElement.style.transform = `translateY(${resetPosition}px)`;
                        }
                       
                        // Принуждаваме браузъра да рендира промяната
                        reelStripElement.offsetHeight; 
                        
                        const duration = 2.5 + i * 0.3;
                        reelStripElement.style.transition = `transform ${duration}s cubic-bezier(0.25, 1, 0.5, 1)`;
                        reelStripElement.style.transform = `translateY(-${targetPosition}px)`;
                        
                        reelStripElement.addEventListener('transitionend', () => {
                            reel.classList.remove('spinning');
                            resolve();
                        }, { once: true });
                    });
                });
                
                await Promise.all(spinPromises);
                
                const { hasWin, winAmount } = await checkWin(results, finalIndexes);
                
                if (!hasWin) {
                    messageBox.textContent = "ИЗБЕРЕТЕ ЗАЛОГ";
                } else {
                     messageBox.textContent = `ПЕЧАЛБА: ${winAmount.toFixed(2)}`;
                }
                
                if (isAutoSpinning) {
                    setTimeout(() => { 
                        isSpinning = false; 
                        spin(currentBet);
                    }, hasWin ? 2000 : 1000);
                } else {
                    isSpinning = false;
                    setControlsDisabled(false);
                }
            }
            
            betSelectionBar.addEventListener('click', (e) => {
                const button = e.target.closest('.bet-spin-btn');
                if (button && !isSpinning) {
                    const betValue = parseFloat(button.dataset.bet);
                    spin(betValue);
                }
            });

            function toggleAutoSpin() {
                isAutoSpinning = !isAutoSpinning;
                autoSpinButton.classList.toggle('active', isAutoSpinning);
                if (isAutoSpinning) {
                    autoSpinButton.textContent = "СТОП";
                    if(!isSpinning) spin(currentBet);
                } else {
                    autoSpinButton.textContent = "AUTO";
                }
            }
            autoSpinButton.addEventListener('click', toggleAutoSpin);
            
            function setControlsDisabled(disabled) {
                document.querySelectorAll('.bet-spin-btn, .control-btn').forEach(btn => {
                    btn.disabled = disabled;
                });
                if(isAutoSpinning) autoSpinButton.disabled = false;
            }

            function clearAnimations() {
                winLinesSvg.innerHTML = '';
                document.querySelectorAll('.symbol').forEach(el => el.classList.remove('win-pulse'));
            }
            
            async function checkWin(results, finalIndexes) {
                let totalWin = 0;
                const winningPositions = new Set();
                
                PAYLINES.forEach((line) => {
                    let firstSymbol = null;
                    for (let i = 0; i < REEL_COUNT; i++) { const s = results[i][line[i]]; if (!SYMBOLS[s]?.isWild) { firstSymbol = s; break; } }
                    if (firstSymbol === null) firstSymbol = 'wild';
                    if (SYMBOLS[firstSymbol]?.isScatter) return;

                    let matchCount = 0;
                    for (let i = 0; i < REEL_COUNT; i++) {
                        const currentSymbol = results[i][line[i]];
                        if (currentSymbol === firstSymbol || SYMBOLS[currentSymbol]?.isWild) matchCount++; else break;
                    }

                    if (matchCount >= 3) {
                        const payout = SYMBOLS[firstSymbol]?.payout?.[matchCount] || 0;
                        totalWin += payout * currentBet;
                        for (let i = 0; i < matchCount; i++) { winningPositions.add(`${i}-${line[i]}`); }
                    }
                });

                if (totalWin > 0) {
                    balance += totalWin;
                    await updateBalanceInFirestore(balance);
                    updateBalanceDisplay();
                    winSound.play().catch(e => {});
                    await updateWin(totalWin, true);
                    flashWinningSymbols(winningPositions, finalIndexes);
                }
                
                return { hasWin: totalWin > 0, winAmount: totalWin };
            }

            function flashWinningSymbols(positions, finalIndexes) {
                positions.forEach(pos => {
                    const [reelIdx, symIdx] = pos.split('-').map(Number);
                    const strip = reelStrips[reelIdx];
                    // Индексът в DOM е (показаният индекс + дължината на лентата)
                    const domIndex = finalIndexes[reelIdx] + symIdx + strip.length;
                    const symbolElement = reels[reelIdx].querySelector(`.reel-strip`).children[domIndex];
                    if (symbolElement) symbolElement.classList.add('win-pulse');
                });
            }

            async function updateWin(amount, animate = false) {
                 if (amount === 0) { winDisplay.textContent = '0.00'; return; }
                 if (animate) {
                    return new Promise(resolve => {
                         let current = 0;
                         const step = amount / 50;
                         const interval = setInterval(() => {
                             current += step;
                             if (current >= amount) {
                                 winDisplay.textContent = amount.toFixed(2);
                                 clearInterval(interval);
                                 resolve();
                             } else {
                                 winDisplay.textContent = current.toFixed(2);
                             }
                         }, 20);
                     });
                 } else { winDisplay.textContent = amount.toFixed(2); }
            }

            function updateBalanceDisplay() { balanceDisplay.textContent = balance.toFixed(2); }
            
            initializeReels();
            initializeUI();
            setInitialReelPositions();
            
            // Функция, която позволява на Firebase да обнови баланса отвън
            return function(newBalance) {
                if (!isSpinning) {
                    balance = newBalance;
                    updateBalanceDisplay();
                }
            };
        }
    </script>
</body>
</html>

